@model List<ServConnect.Models.GasOrder>
@{
    ViewData["Title"] = "Gas Orders Management";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<style>
    :root {
        --gas-gradient: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
        --card-shadow: 0 10px 40px rgba(0,0,0,0.08);
    }
    
    .gas-orders-page {
        min-height: 100vh;
        background: linear-gradient(180deg, #f8fafc 0%, #f1f5f9 100%);
        padding-bottom: 50px;
        overflow-x: hidden;
    }
    
    .gas-header {
        background: var(--gas-gradient);
        padding: 30px;
        border-radius: 0 0 30px 30px;
        margin: -20px 0 30px 0;
        color: #fff;
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
        gap: 16px;
        position: relative;
        overflow: hidden;
    }
    
    .gas-header::before {
        content: '';
        position: absolute;
        top: -50%;
        right: -15%;
        width: 350px;
        height: 350px;
        background: rgba(255,255,255,0.1);
        border-radius: 50%;
    }
    
    .header-content h1 {
        font-size: 1.8rem;
        font-weight: 700;
        margin: 0 0 4px 0;
        position: relative;
        z-index: 1;
    }
    
    .header-content p {
        margin: 0;
        opacity: 0.9;
        position: relative;
        z-index: 1;
    }
    
    .header-actions {
        display: flex;
        gap: 12px;
        position: relative;
        z-index: 1;
    }
    
    .btn-header {
        background: rgba(255,255,255,0.2);
        color: #fff;
        border: none;
        padding: 12px 24px;
        border-radius: 12px;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 8px;
        transition: all 0.2s;
        text-decoration: none;
        backdrop-filter: blur(10px);
    }
    
    .btn-header:hover {
        background: rgba(255,255,255,0.3);
        color: #fff;
        text-decoration: none;
        transform: translateY(-2px);
    }
</style>

<div class="gas-orders-page">
    <!-- Header -->
    <div class="gas-header">
        <div class="header-content">
            <h1><i class="bi bi-fire me-2"></i>Gas Orders</h1>
            <p>Manage gas cylinder orders from IoT auto-booking system</p>
        </div>
        <div class="header-actions">
            <a href="/Vendor/Dashboard" class="btn-header">
                <i class="bi bi-arrow-left"></i>
                Dashboard
            </a>
            <button class="btn-header" onclick="refreshOrders()">
                <i class="bi bi-arrow-clockwise"></i>
                Refresh
            </button>
        </div>
    </div>

    <div class="container-fluid px-3 px-md-4">
    <!-- Stats Cards -->
    <div class="row g-3 mb-4">
        <div class="col-md-3">
            <div class="card border-0 bg-warning bg-opacity-10 h-100">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="rounded-circle bg-warning bg-opacity-25 p-3 me-3">
                            <i class="bi bi-hourglass-split text-warning fs-4"></i>
                        </div>
                        <div>
                            <h3 class="mb-0" id="pendingCount">@Model?.Count(o => o.Status == GasOrderStatus.Pending)</h3>
                            <small class="text-muted">Pending</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-0 bg-info bg-opacity-10 h-100">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="rounded-circle bg-info bg-opacity-25 p-3 me-3">
                            <i class="bi bi-check-circle text-info fs-4"></i>
                        </div>
                        <div>
                            <h3 class="mb-0" id="acceptedCount">@Model?.Count(o => o.Status == GasOrderStatus.Accepted)</h3>
                            <small class="text-muted">Accepted</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-0 bg-primary bg-opacity-10 h-100">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="rounded-circle bg-primary bg-opacity-25 p-3 me-3">
                            <i class="bi bi-truck text-primary fs-4"></i>
                        </div>
                        <div>
                            <h3 class="mb-0" id="deliveryCount">@Model?.Count(o => o.Status == GasOrderStatus.OutForDelivery)</h3>
                            <small class="text-muted">Out for Delivery</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-0 bg-success bg-opacity-10 h-100">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="rounded-circle bg-success bg-opacity-25 p-3 me-3">
                            <i class="bi bi-check2-all text-success fs-4"></i>
                        </div>
                        <div>
                            <h3 class="mb-0" id="deliveredCount">@Model?.Count(o => o.Status == GasOrderStatus.Delivered)</h3>
                            <small class="text-muted">Delivered Today</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Tabs -->
    <ul class="nav nav-tabs mb-4" role="tablist">
        <li class="nav-item">
            <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#pendingTab">
                <i class="bi bi-hourglass-split me-1"></i>Pending
                <span class="badge bg-warning text-dark ms-1" id="pendingBadge">@Model?.Count(o => o.Status == GasOrderStatus.Pending)</span>
            </button>
        </li>
        <li class="nav-item">
            <button class="nav-link" data-bs-toggle="tab" data-bs-target="#activeTab">
                <i class="bi bi-lightning me-1"></i>Active
                <span class="badge bg-primary ms-1" id="activeBadge">@Model?.Count(o => o.Status == GasOrderStatus.Accepted || o.Status == GasOrderStatus.OutForDelivery)</span>
            </button>
        </li>
        <li class="nav-item">
            <button class="nav-link" data-bs-toggle="tab" data-bs-target="#completedTab">
                <i class="bi bi-check-circle me-1"></i>Completed
            </button>
        </li>
    </ul>

    <div class="tab-content">
        <!-- Pending Orders Tab -->
        <div class="tab-pane fade show active" id="pendingTab">
            @{
                var pendingOrders = Model?.Where(o => o.Status == GasOrderStatus.Pending).ToList();
            }
            
            @if (pendingOrders?.Any() == true)
            {
                <div class="row g-4">
                    @foreach (var order in pendingOrders)
                    {
                        <div class="col-lg-6 col-xl-4">
                            <div class="card border-0 shadow-sm h-100 order-card" data-order-id="@order.Id">
                                <div class="card-header bg-warning bg-opacity-10 border-0 py-3">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <span class="badge bg-warning text-dark">
                                            <i class="bi bi-hourglass-split me-1"></i>Pending
                                        </span>
                                        @if (order.IsAutoTriggered)
                                        {
                                            <span class="badge bg-info">
                                                <i class="bi bi-lightning me-1"></i>Auto-Triggered
                                            </span>
                                        }
                                    </div>
                                </div>
                                <div class="card-body">
                                    <h5 class="card-title">@order.UserName</h5>
                                    
                                    <div class="mb-3">
                                        <div class="d-flex align-items-center text-muted mb-1">
                                            <i class="bi bi-telephone me-2"></i>
                                            <a href="tel:@order.UserPhone">@order.UserPhone</a>
                                        </div>
                                        <div class="d-flex align-items-start text-muted">
                                            <i class="bi bi-geo-alt me-2 mt-1"></i>
                                            <span>@order.DeliveryAddress</span>
                                        </div>
                                    </div>
                                    
                                    <div class="d-flex justify-content-between align-items-center mb-3 p-2 bg-light rounded">
                                        <span>@order.GasItemName</span>
                                        <span class="fw-bold text-success">₹@order.Price</span>
                                    </div>
                                    
                                    @if (order.TriggerGasPercentage.HasValue)
                                    {
                                        <div class="alert alert-warning py-2 mb-3">
                                            <small>
                                                <i class="bi bi-info-circle me-1"></i>
                                                Customer's gas at <strong>@order.TriggerGasPercentage.Value.ToString("F0")%</strong>
                                            </small>
                                        </div>
                                    }
                                    
                                    <div class="d-flex gap-2">
                                        <button class="btn btn-success flex-grow-1" onclick="updateOrderStatus('@order.Id', 1)">
                                            <i class="bi bi-check-lg me-1"></i>Accept
                                        </button>
                                        <button class="btn btn-outline-danger" onclick="updateOrderStatus('@order.Id', 5)">
                                            <i class="bi bi-x-lg"></i>
                                        </button>
                                    </div>
                                </div>
                                <div class="card-footer bg-transparent border-0 text-muted small">
                                    <i class="bi bi-clock me-1"></i>@order.CreatedAt.ToString("MMM dd, hh:mm tt")
                                </div>
                            </div>
                        </div>
                    }
                </div>
            }
            else
            {
                <div class="text-center py-5">
                    <i class="bi bi-inbox display-1 text-muted mb-3"></i>
                    <h5>No Pending Orders</h5>
                    <p class="text-muted">New gas orders will appear here</p>
                </div>
            }
        </div>

        <!-- Active Orders Tab -->
        <div class="tab-pane fade" id="activeTab">
            @{
                var activeOrders = Model?.Where(o => o.Status == GasOrderStatus.Accepted || o.Status == GasOrderStatus.OutForDelivery).ToList();
            }
            
            @if (activeOrders?.Any() == true)
            {
                <div class="row g-4">
                    @foreach (var order in activeOrders)
                    {
                        <div class="col-lg-6 col-xl-4">
                            <div class="card border-0 shadow-sm h-100">
                                <div class="card-header @(order.Status == GasOrderStatus.OutForDelivery ? "bg-primary" : "bg-info") bg-opacity-10 border-0 py-3">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <span class="badge @(order.Status == GasOrderStatus.OutForDelivery ? "bg-primary" : "bg-info")">
                                            @if (order.Status == GasOrderStatus.OutForDelivery)
                                            {
                                                <i class="bi bi-truck me-1"></i>@:Out for Delivery
                                            }
                                            else
                                            {
                                                <i class="bi bi-check-circle me-1"></i>@:Accepted
                                            }
                                        </span>
                                        @if (order.IsAutoTriggered)
                                        {
                                            <span class="badge bg-secondary">Auto</span>
                                        }
                                    </div>
                                </div>
                                <div class="card-body">
                                    <h5 class="card-title">@order.UserName</h5>
                                    
                                    <div class="mb-3">
                                        <div class="d-flex align-items-center text-muted mb-1">
                                            <i class="bi bi-telephone me-2"></i>
                                            <a href="tel:@order.UserPhone">@order.UserPhone</a>
                                        </div>
                                        <div class="d-flex align-items-start text-muted">
                                            <i class="bi bi-geo-alt me-2 mt-1"></i>
                                            <span>@order.DeliveryAddress</span>
                                        </div>
                                    </div>
                                    
                                    <div class="d-flex justify-content-between align-items-center mb-3 p-2 bg-light rounded">
                                        <span>@order.GasItemName</span>
                                        <span class="fw-bold text-success">₹@order.Price</span>
                                    </div>
                                    
                                    @if (order.Status == GasOrderStatus.Accepted)
                                    {
                                        <button class="btn btn-primary w-100" onclick="updateOrderStatus('@order.Id', 2)">
                                            <i class="bi bi-truck me-1"></i>Mark Out for Delivery
                                        </button>
                                    }
                                    else
                                    {
                                        <button class="btn btn-success w-100" onclick="updateOrderStatus('@order.Id', 3)">
                                            <i class="bi bi-check2-all me-1"></i>Mark as Delivered
                                        </button>
                                    }
                                </div>
                                <div class="card-footer bg-transparent border-0 text-muted small">
                                    <i class="bi bi-clock me-1"></i>
                                    @if (order.AcceptedAt.HasValue)
                                    {
                                        @:Accepted: @order.AcceptedAt.Value.ToString("hh:mm tt")
                                    }
                                </div>
                            </div>
                        </div>
                    }
                </div>
            }
            else
            {
                <div class="text-center py-5">
                    <i class="bi bi-truck display-1 text-muted mb-3"></i>
                    <h5>No Active Orders</h5>
                    <p class="text-muted">Accept pending orders to see them here</p>
                </div>
            }
        </div>

        <!-- Completed Orders Tab -->
        <div class="tab-pane fade" id="completedTab">
            @{
                var completedOrders = Model?.Where(o => o.Status == GasOrderStatus.Delivered || 
                                                        o.Status == GasOrderStatus.Cancelled || 
                                                        o.Status == GasOrderStatus.Rejected).ToList();
            }
            
            @if (completedOrders?.Any() == true)
            {
                <div class="card border-0 shadow-sm">
                    <div class="table-responsive">
                        <table class="table table-hover mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th>Customer</th>
                                    <th>Item</th>
                                    <th>Price</th>
                                    <th>Date</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var order in completedOrders.Take(20))
                                {
                                    <tr>
                                        <td>
                                            <strong>@order.UserName</strong>
                                            @if (order.IsAutoTriggered)
                                            {
                                                <span class="badge bg-info ms-1">Auto</span>
                                            }
                                            <br />
                                            <small class="text-muted">@order.UserPhone</small>
                                        </td>
                                        <td>@order.GasItemName</td>
                                        <td>₹@order.Price</td>
                                        <td>
                                            @order.CreatedAt.ToString("MMM dd")
                                            <br />
                                            <small class="text-muted">@order.CreatedAt.ToString("hh:mm tt")</small>
                                        </td>
                                        <td>
                                            <span class="badge @GetStatusBadgeClass(order.Status)">
                                                @order.Status
                                            </span>
                                            @if (order.IsDeliveryVerified)
                                            {
                                                <br /><small class="text-success"><i class="bi bi-shield-check"></i> Verified</small>
                                            }
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                </div>
            }
            else
            {
                <div class="text-center py-5">
                    <i class="bi bi-check-circle display-1 text-muted mb-3"></i>
                    <h5>No Completed Orders</h5>
                    <p class="text-muted">Completed orders will appear here</p>
                </div>
            }
        </div>
    </div>
    </div>
</div>

<!-- Status Update Modal -->
<div class="modal fade" id="messageModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add Message (Optional)</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="modalOrderId">
                <input type="hidden" id="modalStatus">
                <textarea class="form-control" id="vendorMessage" rows="3" 
                          placeholder="Add a message for the customer (optional)"></textarea>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="submitStatusUpdate()">Update Status</button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        async function updateOrderStatus(orderId, status) {
            // For reject/cancel, show message modal
            if (status === 5 || status === 4) {
                document.getElementById('modalOrderId').value = orderId;
                document.getElementById('modalStatus').value = status;
                new bootstrap.Modal(document.getElementById('messageModal')).show();
                return;
            }

            await submitStatusUpdateDirect(orderId, status, null);
        }

        async function submitStatusUpdate() {
            const orderId = document.getElementById('modalOrderId').value;
            const status = parseInt(document.getElementById('modalStatus').value);
            const message = document.getElementById('vendorMessage').value;
            
            await submitStatusUpdateDirect(orderId, status, message);
            bootstrap.Modal.getInstance(document.getElementById('messageModal')).hide();
        }

        async function submitStatusUpdateDirect(orderId, status, message) {
            try {
                const response = await fetch(`/api/GasSubscriptionApi/vendor/orders/${orderId}/status`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ status: status, message: message })
                });

                const result = await response.json();

                if (result.success) {
                    // Reload the page to reflect changes
                    location.reload();
                } else {
                    throw new Error(result.message || 'Failed to update status');
                }
            } catch (error) {
                alert('Error: ' + error.message);
            }
        }

        function refreshOrders() {
            location.reload();
        }

        // Auto-refresh every 60 seconds
        setInterval(refreshOrders, 60000);
    </script>
}

@functions {
    string GetStatusBadgeClass(GasOrderStatus status)
    {
        return status switch
        {
            GasOrderStatus.Delivered => "bg-success",
            GasOrderStatus.Cancelled or GasOrderStatus.Rejected => "bg-danger",
            _ => "bg-secondary"
        };
    }
}
