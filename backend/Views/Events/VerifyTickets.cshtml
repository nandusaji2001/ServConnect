@model ServConnect.ViewModels.TicketVerificationViewModel
@{
    ViewData["Title"] = "Verify Tickets";
}

<style>
    .verify-container { max-width: 900px; margin: 0 auto; padding: 24px 16px; }
    
    .page-header {
        display: flex; justify-content: space-between; align-items: center;
        margin-bottom: 32px; flex-wrap: wrap; gap: 16px;
    }
    
    .page-header h1 {
        font-size: 1.8rem; font-weight: 700; color: #1f2937;
        display: flex; align-items: center; gap: 12px;
    }
    
    .page-header h1 i { color: #10B981; }
    
    .event-info {
        background: linear-gradient(135deg, #10B981 0%, #059669 100%);
        color: white; border-radius: 16px; padding: 20px; margin-bottom: 24px;
    }
    
    .event-info h2 { font-size: 1.3rem; margin: 0 0 8px; }
    .event-info p { margin: 0; opacity: 0.9; font-size: 0.95rem; }
    
    .stats-row {
        display: flex; gap: 16px; margin-bottom: 24px; flex-wrap: wrap;
    }
    
    .stat-box {
        flex: 1; min-width: 140px; background: white; border-radius: 12px;
        padding: 20px; text-align: center; box-shadow: 0 2px 10px rgba(0,0,0,0.05);
    }
    
    .stat-box .num { font-size: 2rem; font-weight: 700; color: #10B981; }
    .stat-box .lbl { color: #6b7280; font-size: 0.85rem; }
    
    .verify-section {
        background: white; border-radius: 16px; padding: 24px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.05); margin-bottom: 24px;
    }
    
    .verify-section h3 {
        font-size: 1.2rem; font-weight: 600; margin-bottom: 20px;
        display: flex; align-items: center; gap: 10px;
    }
    
    .verify-section h3 i { color: #10B981; }
    
    .verify-tabs {
        display: flex; gap: 8px; margin-bottom: 20px;
    }
    
    .verify-tab {
        flex: 1; padding: 12px 20px; border: 2px solid #e5e7eb;
        border-radius: 10px; background: white; cursor: pointer;
        font-weight: 500; transition: all 0.2s; text-align: center;
    }
    
    .verify-tab:hover { border-color: #10B981; }
    .verify-tab.active { border-color: #10B981; background: #f0fdf4; color: #059669; }
    .verify-tab i { margin-right: 8px; }
    
    .tab-content { display: none; }
    .tab-content.active { display: block; }
    
    .manual-input {
        display: flex; gap: 12px; margin-bottom: 16px;
    }
    
    .manual-input input {
        flex: 1; padding: 14px 16px; border: 2px solid #e5e7eb;
        border-radius: 10px; font-size: 1rem; text-transform: uppercase;
    }
    
    .manual-input input:focus { outline: none; border-color: #10B981; }
    
    .manual-input button {
        padding: 14px 24px; background: #10B981; color: white;
        border: none; border-radius: 10px; font-weight: 600; cursor: pointer;
    }
    
    .manual-input button:hover { background: #059669; }
    
    .qr-scanner-container {
        position: relative; max-width: 400px; margin: 0 auto;
    }
    
    #qr-reader { width: 100%; border-radius: 12px; overflow: hidden; }
    #qr-reader video { border-radius: 12px; }
    
    .scanner-overlay {
        position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
        width: 200px; height: 200px; border: 3px solid #10B981;
        border-radius: 16px; pointer-events: none;
        box-shadow: 0 0 0 9999px rgba(0,0,0,0.3);
    }
    
    .scanner-controls {
        display: flex; justify-content: center; gap: 12px; margin-top: 16px;
    }
    
    .result-card {
        padding: 20px; border-radius: 12px; margin-top: 20px;
        display: none; animation: slideIn 0.3s ease;
    }
    
    @@keyframes slideIn {
        from { opacity: 0; transform: translateY(-10px); }
        to { opacity: 1; transform: translateY(0); }
    }
    
    .result-card.success { background: #d1fae5; border: 2px solid #10B981; }
    .result-card.error { background: #fee2e2; border: 2px solid #ef4444; }
    .result-card.warning { background: #fef3c7; border: 2px solid #f59e0b; }
    
    .result-card .icon { font-size: 2rem; margin-bottom: 12px; }
    .result-card.success .icon { color: #10B981; }
    .result-card.error .icon { color: #ef4444; }
    .result-card.warning .icon { color: #f59e0b; }
    
    .result-card .message { font-size: 1.1rem; font-weight: 600; margin-bottom: 8px; }
    .result-card .details { color: #6b7280; font-size: 0.9rem; }
    
    .ticket-details {
        background: #f9fafb; border-radius: 8px; padding: 12px; margin-top: 12px;
    }
    
    .ticket-details .row { display: flex; justify-content: space-between; padding: 4px 0; }
    .ticket-details .label { color: #6b7280; }
    .ticket-details .value { font-weight: 600; }
    
    .recent-section h3 { margin-bottom: 16px; }
    
    .recent-list { max-height: 400px; overflow-y: auto; }
    
    .recent-item {
        display: flex; align-items: center; gap: 12px;
        padding: 12px; border-bottom: 1px solid #f3f4f6;
    }
    
    .recent-item:last-child { border-bottom: none; }
    
    .recent-item .avatar {
        width: 40px; height: 40px; border-radius: 50%;
        background: #d1fae5; color: #10B981;
        display: flex; align-items: center; justify-content: center;
    }
    
    .recent-item .info { flex: 1; }
    .recent-item .info h5 { margin: 0; font-size: 0.95rem; }
    .recent-item .info p { margin: 0; font-size: 0.8rem; color: #6b7280; }
    
    .recent-item .badge {
        padding: 4px 10px; border-radius: 20px; font-size: 0.75rem; font-weight: 600;
    }
    
    .badge-verified { background: #d1fae5; color: #059669; }
    .badge-partial { background: #fef3c7; color: #d97706; }
    
    .empty-state { text-align: center; padding: 40px; color: #9ca3af; }
    .empty-state i { font-size: 3rem; margin-bottom: 12px; opacity: 0.5; }
    
    @@media (max-width: 768px) {
        .verify-container { padding: 16px 12px; }
        .manual-input { flex-direction: column; }
        .verify-tabs { flex-direction: column; }
    }
</style>

<div class="verify-container">
    <div class="page-header">
        <h1><i class="fas fa-qrcode"></i> Verify Tickets</h1>
        <a href="@Url.Action("OrganizerDashboard")" class="btn btn-outline-secondary">
            <i class="fas fa-arrow-left me-2"></i>Back to Dashboard
        </a>
    </div>

    <div class="event-info">
        <h2>@Model.Event?.Title</h2>
        <p><i class="fas fa-calendar me-2"></i>@Model.Event?.StartDateTime.ToLocalTime().ToString("dddd, dd MMM yyyy • hh:mm tt")</p>
        <p><i class="fas fa-map-marker-alt me-2"></i>@Model.Event?.Venue</p>
    </div>

    <div class="stats-row" id="statsRow">
        <div class="stat-box">
            <div class="num" id="statVerified">@Model.TotalVerified</div>
            <div class="lbl">Entries Verified</div>
        </div>
        <div class="stat-box">
            <div class="num" id="statTotal">@Model.TotalTickets</div>
            <div class="lbl">Total Tickets</div>
        </div>
        <div class="stat-box">
            <div class="num" id="statRemaining">@(Model.TotalTickets - Model.TotalVerified)</div>
            <div class="lbl">Remaining</div>
        </div>
    </div>

    <div class="verify-section">
        <h3><i class="fas fa-check-circle"></i> Verify Entry</h3>
        
        <div class="verify-tabs">
            <div class="verify-tab active" onclick="switchTab('manual')">
                <i class="fas fa-keyboard"></i>Enter Code
            </div>
            <div class="verify-tab" onclick="switchTab('qr')">
                <i class="fas fa-qrcode"></i>Scan QR Code
            </div>
        </div>

        <div id="manual-tab" class="tab-content active">
            <div class="manual-input">
                <input type="text" id="ticketCode" placeholder="Enter ticket code (e.g., EVT-20260107-ABC12345)" 
                       onkeypress="if(event.key==='Enter') verifyManual()">
                <button onclick="verifyManual()">
                    <i class="fas fa-check me-2"></i>Verify
                </button>
            </div>
            <p class="text-muted small">Enter the ticket code shown on the attendee's ticket. All entries on the ticket will be verified at once.</p>
        </div>

        <div id="qr-tab" class="tab-content">
            <div class="qr-scanner-container">
                <div id="qr-reader"></div>
            </div>
            <div class="scanner-controls">
                <button class="btn btn-outline-primary" onclick="startScanner()">
                    <i class="fas fa-play me-2"></i>Start Scanner
                </button>
                <button class="btn btn-outline-secondary" onclick="stopScanner()">
                    <i class="fas fa-stop me-2"></i>Stop
                </button>
            </div>
            <p class="text-muted small text-center mt-3">Point camera at the QR code. All entries on the ticket will be verified at once.</p>
        </div>

        <div id="verifyResult" class="result-card"></div>
    </div>

    <div class="verify-section recent-section">
        <h3><i class="fas fa-history"></i> Recent Verifications</h3>
        
        <div class="recent-list" id="recentList">
            @if (Model.RecentVerifications.Any())
            {
                @foreach (var ticket in Model.RecentVerifications)
                {
                    <div class="recent-item">
                        <div class="avatar"><i class="fas fa-user"></i></div>
                        <div class="info">
                            <h5>@ticket.UserName <span class="text-muted small">(@ticket.Quantity person(s))</span></h5>
                            <p>@ticket.TicketCode • Verified @ticket.LastVerifiedAt?.ToLocalTime().ToString("dd MMM, hh:mm tt")</p>
                        </div>
                        <span class="badge badge-verified">
                            <i class="fas fa-check me-1"></i>@ticket.VerifiedCount admitted
                        </span>
                    </div>
                }
            }
            else
            {
                <div class="empty-state" id="emptyState">
                    <i class="fas fa-clipboard-check"></i>
                    <p>No tickets verified yet</p>
                </div>
            }
        </div>
    </div>
</div>

<script src="https://unpkg.com/html5-qrcode"></script>
<script>
    const eventId = '@Model.EventId';
    let html5QrCode = null;
    let isScanning = false;
    
    // Track current stats
    let currentVerified = @Model.TotalVerified;
    let currentTotal = @Model.TotalTickets;

    function switchTab(tab) {
        document.querySelectorAll('.verify-tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
        
        document.querySelector(`.verify-tab:nth-child(${tab === 'manual' ? 1 : 2})`).classList.add('active');
        document.getElementById(`${tab}-tab`).classList.add('active');
        
        if (tab === 'manual' && isScanning) {
            stopScanner();
        }
    }

    function verifyManual() {
        const code = document.getElementById('ticketCode').value.trim();
        if (!code) {
            showResult('error', 'Please enter a ticket code', null);
            return;
        }
        verifyTicket(code, 'Manual');
    }

    async function verifyTicket(code, method) {
        try {
            const response = await fetch('/Events/VerifyTicketByCode', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ eventId, code, method })
            });
            
            const result = await response.json();
            
            if (result.success) {
                showResult('success', result.message, result.ticket);
                document.getElementById('ticketCode').value = '';
                
                // Update stats and recent list
                updateStatsAndList(result.ticket);
                
                // Play success sound
                playSound('success');
            } else {
                const type = result.errorCode === 'ALREADY_USED' ? 'warning' : 'error';
                showResult(type, result.message, result.ticket);
                playSound('error');
            }
        } catch (error) {
            showResult('error', 'Verification failed. Please try again.', null);
        }
    }
    
    function updateStatsAndList(ticket) {
        if (!ticket) return;
        
        // Update stats
        currentVerified = ticket.verifiedCount;
        document.getElementById('statVerified').textContent = currentVerified;
        
        // Recalculate remaining (need to fetch fresh data or estimate)
        // For now, we'll refresh stats from server
        refreshStats();
        
        // Add to recent list
        addToRecentList(ticket);
    }
    
    async function refreshStats() {
        try {
            const response = await fetch('/Events/GetVerificationStats?eventId=' + encodeURIComponent(eventId));
            const data = await response.json();
            if (data.success) {
                document.getElementById('statVerified').textContent = data.totalVerified;
                document.getElementById('statTotal').textContent = data.totalTickets;
                document.getElementById('statRemaining').textContent = data.remaining;
            }
        } catch (e) {
            console.error('Failed to refresh stats:', e);
        }
    }
    
    function addToRecentList(ticket) {
        const recentList = document.getElementById('recentList');
        const emptyState = document.getElementById('emptyState');
        
        // Remove empty state if present
        if (emptyState) {
            emptyState.remove();
        }
        
        // Create new recent item
        const now = new Date();
        const timeStr = now.toLocaleString('en-US', { day: '2-digit', month: 'short', hour: '2-digit', minute: '2-digit', hour12: true });
        
        const newItem = document.createElement('div');
        newItem.className = 'recent-item';
        newItem.style.animation = 'slideIn 0.3s ease';
        newItem.innerHTML = `
            <div class="avatar"><i class="fas fa-user"></i></div>
            <div class="info">
                <h5>${ticket.userName} <span class="text-muted small">(${ticket.quantity} person(s))</span></h5>
                <p>${ticket.ticketCode} • Verified ${timeStr}</p>
            </div>
            <span class="badge badge-verified">
                <i class="fas fa-check me-1"></i>${ticket.verifiedCount} admitted
            </span>
        `;
        
        // Insert at the top
        recentList.insertBefore(newItem, recentList.firstChild);
        
        // Keep only last 20 items
        const items = recentList.querySelectorAll('.recent-item');
        if (items.length > 20) {
            items[items.length - 1].remove();
        }
    }

    function showResult(type, message, ticket) {
        const resultDiv = document.getElementById('verifyResult');
        const icons = { success: 'fa-check-circle', error: 'fa-times-circle', warning: 'fa-exclamation-triangle' };
        
        let html = `
            <div class="icon"><i class="fas ${icons[type]}"></i></div>
            <div class="message">${message}</div>
        `;
        
        if (ticket) {
            html += `
                <div class="ticket-details">
                    <div class="row"><span class="label">Name</span><span class="value">${ticket.userName}</span></div>
                    <div class="row"><span class="label">Ticket Code</span><span class="value">${ticket.ticketCode}</span></div>
                    <div class="row"><span class="label">Total Persons</span><span class="value">${ticket.quantity}</span></div>
                    <div class="row"><span class="label">Admitted</span><span class="value">${ticket.verifiedCount} of ${ticket.quantity}</span></div>
                    <div class="row"><span class="label">Status</span><span class="value">${ticket.verifiedCount >= ticket.quantity ? '✓ All Admitted' : 'Pending'}</span></div>
                </div>
            `;
        }
        
        resultDiv.className = `result-card ${type}`;
        resultDiv.innerHTML = html;
        resultDiv.style.display = 'block';
        
        // Auto-hide after 5 seconds for success
        if (type === 'success') {
            setTimeout(() => { resultDiv.style.display = 'none'; }, 5000);
        }
    }

    function playSound(type) {
        // Simple beep using Web Audio API
        try {
            const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            const oscillator = audioCtx.createOscillator();
            const gainNode = audioCtx.createGain();
            
            oscillator.connect(gainNode);
            gainNode.connect(audioCtx.destination);
            
            oscillator.frequency.value = type === 'success' ? 800 : 300;
            oscillator.type = 'sine';
            gainNode.gain.value = 0.3;
            
            oscillator.start();
            setTimeout(() => oscillator.stop(), type === 'success' ? 150 : 300);
        } catch (e) { }
    }

    async function startScanner() {
        if (isScanning) return;
        
        try {
            html5QrCode = new Html5Qrcode("qr-reader");
            await html5QrCode.start(
                { facingMode: "environment" },
                { fps: 10, qrbox: { width: 250, height: 250 } },
                (decodedText) => {
                    // QR code scanned successfully
                    verifyTicket(decodedText, 'QR');
                    // Brief pause before next scan
                    stopScanner();
                    setTimeout(startScanner, 2000);
                },
                (errorMessage) => { /* Ignore scan errors */ }
            );
            isScanning = true;
        } catch (err) {
            console.error('Scanner error:', err);
            showResult('error', 'Could not start camera. Please check permissions.', null);
        }
    }

    function stopScanner() {
        if (html5QrCode && isScanning) {
            html5QrCode.stop().then(() => {
                isScanning = false;
            }).catch(err => console.error('Stop error:', err));
        }
    }

    // Cleanup on page leave
    window.addEventListener('beforeunload', stopScanner);
</script>
