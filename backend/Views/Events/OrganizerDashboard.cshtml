@model ServConnect.ViewModels.OrganizerDashboardViewModel
@{
    ViewData["Title"] = "Organizer Dashboard";
}

<style>
    .organizer-container { max-width: 1200px; margin: 0 auto; padding: 24px 16px; }
    
    @@media (min-width: 1200px) {
        .organizer-container { padding: 24px 32px; }
    }
    
    .page-header {
        display: flex; justify-content: space-between; align-items: center;
        margin-bottom: 32px; flex-wrap: wrap; gap: 16px;
    }
    
    .page-header h1 {
        font-size: 2rem; font-weight: 700; color: #1f2937;
        display: flex; align-items: center; gap: 12px;
    }
    
    .page-header h1 i { color: #10B981; }
    
    .stats-grid {
        display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
        gap: 20px; margin-bottom: 32px;
    }
    
    .stat-card {
        background: white; border-radius: 16px; padding: 24px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.05);
    }
    
    .stat-card .icon {
        width: 50px; height: 50px; border-radius: 12px;
        display: flex; align-items: center; justify-content: center;
        font-size: 1.3rem; margin-bottom: 16px;
    }
    
    .stat-card .icon.events { background: #dbeafe; color: #3b82f6; }
    .stat-card .icon.active { background: #d1fae5; color: #10b981; }
    .stat-card .icon.cancelled { background: #fee2e2; color: #ef4444; }
    .stat-card .icon.tickets { background: #e0e7ff; color: #6366f1; }
    .stat-card .icon.revenue { background: #fef3c7; color: #f59e0b; }
    
    .stat-card .value { font-size: 2rem; font-weight: 700; color: #1f2937; }
    .stat-card .label { color: #6b7280; font-size: 0.9rem; }
    
    .section-card {
        background: white; border-radius: 16px; padding: 24px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.05); margin-bottom: 24px;
    }
    
    .section-header {
        display: flex; justify-content: space-between; align-items: center;
        margin-bottom: 20px;
    }
    
    .section-header h2 {
        font-size: 1.3rem; font-weight: 600; color: #1f2937;
        display: flex; align-items: center; gap: 10px;
    }
    
    .section-header h2 i { color: #10B981; }
    
    .event-row {
        display: flex; align-items: center; gap: 16px;
        padding: 16px; border-radius: 12px; margin-bottom: 12px;
        background: #f9fafb; transition: all 0.2s;
    }
    
    .event-row:hover { background: #f0fdf4; }
    .event-row.cancelled { background: #fef2f2; opacity: 0.8; }
    .event-row.cancelled:hover { background: #fee2e2; }
    
    .event-row .date {
        width: 60px; height: 60px; border-radius: 12px;
        background: linear-gradient(135deg, #10B981 0%, #059669 100%);
        color: white; display: flex; flex-direction: column;
        align-items: center; justify-content: center; flex-shrink: 0;
    }
    
    .event-row.cancelled .date {
        background: linear-gradient(135deg, #9ca3af 0%, #6b7280 100%);
    }
    
    .event-row .date .day { font-size: 1.3rem; font-weight: 700; line-height: 1; }
    .event-row .date .month { font-size: 0.7rem; text-transform: uppercase; }
    
    .event-row .info { flex: 1; }
    .event-row .info h4 { font-size: 1rem; font-weight: 600; color: #1f2937; margin: 0 0 4px; display: flex; align-items: center; gap: 8px; }
    .event-row .info p { font-size: 0.85rem; color: #6b7280; margin: 0; }
    
    .status-badge { font-size: 0.7rem; padding: 2px 8px; border-radius: 10px; font-weight: 500; }
    .status-badge.cancelled { background: #fee2e2; color: #dc2626; }
    .status-badge.published { background: #d1fae5; color: #059669; }
    .status-badge.completed { background: #e0e7ff; color: #4f46e5; }
    .status-badge.ended { background: #f3f4f6; color: #6b7280; }
    
    .event-row.ended { background: #f3f4f6; opacity: 0.85; }
    .event-row.ended:hover { background: #e5e7eb; }
    .event-row.ended .date {
        background: linear-gradient(135deg, #6b7280 0%, #4b5563 100%);
    }
    
    .event-row .stats { display: flex; gap: 20px; }
    .event-row .stats .stat { text-align: center; }
    .event-row .stats .stat .num { font-weight: 700; color: #1f2937; }
    .event-row .stats .stat .lbl { font-size: 0.75rem; color: #9ca3af; }
    
    .event-row .actions { display: flex; gap: 8px; }
    
    .event-sales-section { margin-bottom: 24px; }
    .event-sales-header {
        display: flex; align-items: center; gap: 12px; padding: 12px 16px;
        background: #f0fdf4; border-radius: 10px; margin-bottom: 12px; cursor: pointer;
    }
    .event-sales-header.cancelled { background: #fef2f2; }
    .event-sales-header.ended { background: #f3f4f6; }
    .event-sales-header h4 { margin: 0; font-size: 1rem; font-weight: 600; flex: 1; }
    .event-sales-header .toggle-icon { transition: transform 0.2s; }
    .event-sales-header.collapsed .toggle-icon { transform: rotate(-90deg); }
    
    .sale-row {
        display: flex; align-items: center; gap: 12px;
        padding: 12px; border-bottom: 1px solid #f3f4f6;
    }
    
    .sale-row:last-child { border-bottom: none; }
    
    .sale-row .avatar {
        width: 40px; height: 40px; border-radius: 50%;
        background: #e5e7eb; display: flex; align-items: center;
        justify-content: center; color: #6b7280;
    }
    
    .sale-row .info { flex: 1; }
    .sale-row .info h5 { font-size: 0.9rem; font-weight: 500; margin: 0; }
    .sale-row .info p { font-size: 0.8rem; color: #9ca3af; margin: 0; }
    
    .sale-row .amount { font-weight: 600; color: #10B981; }
    .sale-row .amount.cancelled { color: #ef4444; font-size: 0.85rem; }
    .sale-row .amount.free { color: #6b7280; }
    
    .empty-state { text-align: center; padding: 40px; color: #6b7280; }
    .empty-state i { font-size: 3rem; opacity: 0.3; margin-bottom: 12px; }

    @@media (max-width: 768px) {
        .organizer-container { padding: 16px 12px; }
        .event-row { flex-direction: column; align-items: flex-start; }
        .event-row .stats { width: 100%; justify-content: space-around; margin: 12px 0; }
    }
</style>

<div class="organizer-container">
    <div class="page-header">
        <h1><i class="fas fa-chart-line"></i> Organizer Dashboard</h1>
        <div>
            <a href="@Url.Action("Index", "Events")" class="btn btn-outline-secondary me-2">
                <i class="fas fa-arrow-left me-2"></i>Back
            </a>
            <a href="@Url.Action("Create", "Events")" class="btn btn-primary">
                <i class="fas fa-plus me-2"></i>Create Event
            </a>
        </div>
    </div>

    <!-- Stats -->
    <div class="stats-grid">
        <div class="stat-card">
            <div class="icon events"><i class="fas fa-calendar-alt"></i></div>
            <div class="value">@Model.TotalEvents</div>
            <div class="label">Total Events</div>
        </div>
        <div class="stat-card">
            <div class="icon active"><i class="fas fa-calendar-check"></i></div>
            <div class="value">@Model.ActiveEvents</div>
            <div class="label">Active Events</div>
        </div>
        @if (Model.CompletedEvents > 0)
        {
            <div class="stat-card">
                <div class="icon" style="background: #e0e7ff; color: #4f46e5;"><i class="fas fa-flag-checkered"></i></div>
                <div class="value">@Model.CompletedEvents</div>
                <div class="label">Completed</div>
            </div>
        }
        @if (Model.CancelledEvents > 0)
        {
            <div class="stat-card">
                <div class="icon cancelled"><i class="fas fa-calendar-times"></i></div>
                <div class="value">@Model.CancelledEvents</div>
                <div class="label">Cancelled</div>
            </div>
        }
        <div class="stat-card">
            <div class="icon tickets"><i class="fas fa-ticket-alt"></i></div>
            <div class="value">@Model.TotalTicketsSold</div>
            <div class="label">Tickets Sold</div>
        </div>
        <div class="stat-card">
            <div class="icon revenue"><i class="fas fa-rupee-sign"></i></div>
            <div class="value">₹@Model.TotalRevenue.ToString("N0")</div>
            <div class="label">Total Revenue</div>
        </div>
    </div>

    <!-- My Events -->
    <div class="section-card">
        <div class="section-header">
            <h2><i class="fas fa-calendar-check"></i> My Events</h2>
        </div>
        
        @if (Model.MyEvents.Any())
        {
            @foreach (var evt in Model.MyEvents)
            {
                var eventDate = evt.StartDateTime.ToLocalTime();
                var isCancelled = evt.Status == ServConnect.Models.EventStatus.Cancelled;
                var isCompleted = evt.Status == ServConnect.Models.EventStatus.Completed;
                var isEnded = evt.IsEnded && !isCancelled;
                var rowClass = isCancelled ? "cancelled" : (isEnded || isCompleted ? "ended" : "");
                
                <div class="event-row @rowClass">
                    <div class="date">
                        <span class="day">@eventDate.Day</span>
                        <span class="month">@eventDate.ToString("MMM")</span>
                    </div>
                    <div class="info">
                        <h4>
                            @evt.Title
                            @if (isCancelled)
                            {
                                <span class="status-badge cancelled">Cancelled</span>
                            }
                            else if (isCompleted || isEnded)
                            {
                                <span class="status-badge ended">Event Ended</span>
                            }
                            else
                            {
                                <span class="status-badge published">Active</span>
                            }
                        </h4>
                        <p><i class="fas fa-map-marker-alt me-1"></i>@evt.Venue</p>
                    </div>
                    <div class="stats">
                        <div class="stat">
                            <div class="num">@evt.TicketsSold</div>
                            <div class="lbl">Sold</div>
                        </div>
                        <div class="stat">
                            <div class="num">@(isCancelled || isEnded || isCompleted ? "-" : evt.RemainingSeats.ToString())</div>
                            <div class="lbl">Left</div>
                        </div>
                    </div>
                    <div class="actions">
                        <a href="@Url.Action("Details", "Events", new { id = evt.Id })" class="btn btn-sm btn-outline-primary" title="View">
                            <i class="fas fa-eye"></i>
                        </a>
                        @if (!isCancelled && !isEnded && !isCompleted)
                        {
                            <a href="@Url.Action("VerifyTickets", "Events", new { eventId = evt.Id })" class="btn btn-sm btn-success" title="Verify Tickets">
                                <i class="fas fa-qrcode"></i>
                            </a>
                            <a href="@Url.Action("Edit", "Events", new { id = evt.Id })" class="btn btn-sm btn-outline-secondary" title="Edit">
                                <i class="fas fa-edit"></i>
                            </a>
                        }
                    </div>
                </div>
            }
        }
        else
        {
            <div class="empty-state">
                <i class="fas fa-calendar-plus"></i>
                <h4>No events yet</h4>
                <p>Create your first event to get started!</p>
            </div>
        }
    </div>

    <!-- Ticket Sales by Event -->
    <div class="section-card">
        <div class="section-header">
            <h2><i class="fas fa-shopping-cart"></i> Ticket Sales by Event</h2>
        </div>
        
        @if (Model.SalesByEvent.Any())
        {
            @foreach (var eventSales in Model.SalesByEvent.OrderByDescending(x => x.Value.FirstOrDefault()?.PurchasedAt))
            {
                var eventId = eventSales.Key;
                var sales = eventSales.Value;
                var eventInfo = Model.EventsDict.GetValueOrDefault(eventId);
                var isEventCancelled = eventInfo?.Status == ServConnect.Models.EventStatus.Cancelled;
                var isEventEnded = eventInfo?.IsEnded == true || eventInfo?.Status == ServConnect.Models.EventStatus.Completed;
                var headerClass = isEventCancelled ? "cancelled" : (isEventEnded ? "ended" : "");
                
                <div class="event-sales-section">
                    <div class="event-sales-header @headerClass" onclick="toggleSales(this)">
                        <i class="fas fa-chevron-down toggle-icon"></i>
                        <h4>
                            @(eventInfo?.Title ?? "Unknown Event")
                            @if (isEventCancelled)
                            {
                                <span class="status-badge cancelled ms-2">Cancelled</span>
                            }
                            else if (isEventEnded)
                            {
                                <span class="status-badge ended ms-2">Event Ended</span>
                            }
                        </h4>
                        <span class="text-muted">@sales.Count sale(s)</span>
                    </div>
                    <div class="sales-list">
                        @foreach (var sale in sales.Take(5))
                        {
                            var isTicketCancelled = sale.Status == ServConnect.Models.TicketStatus.Cancelled;
                            <div class="sale-row">
                                <div class="avatar"><i class="fas fa-user"></i></div>
                                <div class="info">
                                    <h5>@sale.UserName</h5>
                                    <p>@sale.Quantity ticket(s) • @sale.PurchasedAt.ToLocalTime().ToString("dd MMM, hh:mm tt")</p>
                                </div>
                                <div class="amount @(isTicketCancelled ? "cancelled" : (sale.TotalAmount == 0 ? "free" : ""))">
                                    @if (isTicketCancelled)
                                    {
                                        <i class="fas fa-times-circle me-1"></i>@:Cancelled
                                    }
                                    else if (sale.TotalAmount > 0)
                                    {
                                        @:₹@sale.TotalAmount
                                    }
                                    else
                                    {
                                        @:Free
                                    }
                                </div>
                            </div>
                        }
                        @if (sales.Count > 5)
                        {
                            <p class="text-center text-muted small py-2">+ @(sales.Count - 5) more sales</p>
                        }
                    </div>
                </div>
            }
        }
        else
        {
            <div class="empty-state">
                <i class="fas fa-receipt"></i>
                <p>No ticket sales yet</p>
            </div>
        }
    </div>
</div>

<script>
function toggleSales(header) {
    header.classList.toggle('collapsed');
    const salesList = header.nextElementSibling;
    if (salesList) {
        salesList.style.display = header.classList.contains('collapsed') ? 'none' : 'block';
    }
}
</script>
