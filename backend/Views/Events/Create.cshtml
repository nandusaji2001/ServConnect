@model ServConnect.ViewModels.CreateEventViewModel
@{
    ViewData["Title"] = "Create Event";
    var categories = new[] { "Music", "Sports", "Arts", "Food & Drink", "Community", "Education", "Business", "Health", "Technology", "Other" };
}

<style>
    .create-container { max-width: 900px; margin: 0 auto; padding: 24px 16px; }
    
    @@media (min-width: 1200px) {
        .create-container { padding: 24px 32px; }
    }
    
    @@media (max-width: 768px) {
        .create-container { padding: 16px 12px; }
    }
    .page-header { margin-bottom: 32px; display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 16px; }
    .page-header h1 { font-size: 2rem; font-weight: 700; color: #1f2937; display: flex; align-items: center; gap: 12px; }
    .page-header h1 i { color: #10B981; }
    .form-card { background: white; border-radius: 16px; padding: 32px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); }
    .form-section { margin-bottom: 32px; padding-bottom: 24px; border-bottom: 1px solid #e5e7eb; }
    .form-section:last-child { border-bottom: none; margin-bottom: 0; }
    .section-title { font-size: 1.2rem; font-weight: 600; color: #1f2937; margin-bottom: 20px; display: flex; align-items: center; gap: 10px; }
    .section-title i { color: #10B981; }
    .form-label { font-weight: 500; color: #374151; margin-bottom: 6px; }
    .form-control, .form-select { border-radius: 10px; border: 1px solid #d1d5db; padding: 12px 16px; font-size: 1rem; }
    .form-control:focus, .form-select:focus { border-color: #10B981; box-shadow: 0 0 0 3px rgba(16,185,129,0.1); }
    .form-control.is-invalid { border-color: #ef4444; }
    .form-control.is-valid { border-color: #10B981; }
    .form-text { color: #6b7280; font-size: 0.85rem; }
    .price-toggle { display: flex; gap: 16px; margin-bottom: 16px; }
    .price-option { flex: 1; padding: 16px; border: 2px solid #e5e7eb; border-radius: 12px; cursor: pointer; text-align: center; transition: all 0.2s; }
    .price-option:hover { border-color: #10B981; }
    .price-option.active { border-color: #10B981; background: #f0fdf4; }
    .price-option i { font-size: 1.5rem; margin-bottom: 8px; color: #10B981; }
    .price-option h4 { font-size: 1rem; font-weight: 600; margin: 0; }
    .price-option p { font-size: 0.85rem; color: #6b7280; margin: 4px 0 0; }
    #priceSection { display: none; }
    #priceSection.show { display: block; }
    #map { height: 300px; border-radius: 12px; margin-top: 12px; }
    .validation-error { color: #ef4444; font-size: 0.85rem; margin-top: 4px; display: none; }
    .validation-error.show { display: block; }
    .validation-warning { background: #fef3c7; border: 1px solid #f59e0b; color: #92400e; padding: 12px 16px; border-radius: 10px; margin-bottom: 20px; display: none; }
    .validation-warning.show { display: flex; align-items: center; gap: 10px; }
    .validation-warning i { color: #f59e0b; }
</style>

<style>
    .image-upload-container { display: flex; gap: 16px; margin-bottom: 16px; }
    .image-upload-tab { flex: 1; padding: 12px; border: 2px solid #e5e7eb; border-radius: 10px; cursor: pointer; text-align: center; transition: all 0.2s; }
    .image-upload-tab:hover { border-color: #10B981; }
    .image-upload-tab.active { border-color: #10B981; background: #f0fdf4; }
    .image-upload-area { border: 2px dashed #d1d5db; border-radius: 12px; padding: 40px; text-align: center; cursor: pointer; transition: all 0.2s; display: none; }
    .image-upload-area.show { display: block; }
    .image-upload-area:hover { border-color: #10B981; background: #f0fdf4; }
    .image-upload-area i { font-size: 2.5rem; color: #9ca3af; margin-bottom: 12px; }
    .image-preview { margin-top: 16px; }
    .image-preview img { max-width: 200px; max-height: 150px; border-radius: 8px; object-fit: cover; }
    .btn-submit { background: linear-gradient(135deg, #10B981 0%, #059669 100%); color: white; padding: 14px 32px; border-radius: 12px; font-weight: 600; font-size: 1rem; border: none; cursor: pointer; transition: all 0.3s; }
    .btn-submit:hover:not(:disabled) { transform: translateY(-2px); box-shadow: 0 10px 30px rgba(16,185,129,0.3); }
    .btn-submit:disabled { opacity: 0.6; cursor: not-allowed; transform: none; }
    .geocode-status { font-size: 0.85rem; margin-top: 8px; }
    .geocode-status.success { color: #10B981; }
    .geocode-status.error { color: #ef4444; }
    .geocode-status.loading { color: #6b7280; }
</style>

<div class="create-container">
    <div class="page-header">
        <h1><i class="fas fa-plus-circle"></i> Create New Event</h1>
        <a href="@Url.Action("Index", "Events")" class="btn btn-outline-secondary">
            <i class="fas fa-arrow-left me-2"></i>Back to Events
        </a>
    </div>

    <div class="validation-warning" id="formWarning">
        <i class="fas fa-exclamation-triangle"></i>
        <span id="warningMessage">Please fill in all required fields before submitting.</span>
    </div>

    <div class="form-card">
        <form asp-action="Create" method="post" id="createEventForm" enctype="multipart/form-data">
            @Html.AntiForgeryToken()

            <!-- Basic Info -->
            <div class="form-section">
                <h3 class="section-title"><i class="fas fa-info-circle"></i> Basic Information</h3>
                
                <div class="mb-3">
                    <label asp-for="Title" class="form-label">Event Title *</label>
                    <input asp-for="Title" class="form-control" placeholder="Enter a catchy title for your event" id="titleInput" />
                    <span asp-validation-for="Title" class="text-danger"></span>
                    <div class="validation-error" id="titleError">Title must be between 5 and 200 characters</div>
                </div>

                <div class="mb-3">
                    <label asp-for="Description" class="form-label">Description *</label>
                    <textarea asp-for="Description" class="form-control" rows="5" placeholder="Describe your event in detail..." id="descriptionInput"></textarea>
                    <span asp-validation-for="Description" class="text-danger"></span>
                    <div class="validation-error" id="descriptionError">Description must be between 20 and 5000 characters</div>
                </div>

                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label asp-for="Category" class="form-label">Category *</label>
                        <select asp-for="Category" class="form-select" id="categoryInput">
                            <option value="">Select a category</option>
                            @foreach (var cat in categories)
                            {
                                <option value="@cat">@cat</option>
                            }
                        </select>
                        <span asp-validation-for="Category" class="text-danger"></span>
                        <div class="validation-error" id="categoryError">Please select a category</div>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label asp-for="Capacity" class="form-label">Capacity * (Max: 1,000)</label>
                        <input asp-for="Capacity" type="number" class="form-control" min="1" max="1000" placeholder="Max attendees" id="capacityInput" />
                        <span asp-validation-for="Capacity" class="text-danger"></span>
                        <div class="validation-error" id="capacityError">Capacity must be between 1 and 1,000</div>
                    </div>
                </div>
            </div>

            <!-- Date & Time -->
            <div class="form-section">
                <h3 class="section-title"><i class="fas fa-clock"></i> Date & Time</h3>
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label asp-for="StartDateTime" class="form-label">Start Date & Time *</label>
                        <input asp-for="StartDateTime" type="datetime-local" class="form-control" id="startDateInput" />
                        <span asp-validation-for="StartDateTime" class="text-danger"></span>
                        <div class="validation-error" id="startDateError">Start date cannot be in the past</div>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label asp-for="EndDateTime" class="form-label">End Date & Time *</label>
                        <input asp-for="EndDateTime" type="datetime-local" class="form-control" id="endDateInput" />
                        <span asp-validation-for="EndDateTime" class="text-danger"></span>
                        <div class="validation-error" id="endDateError">End date must be after start date and within 3 months</div>
                    </div>
                </div>
                <p class="form-text"><i class="fas fa-info-circle me-1"></i>Events cannot extend beyond 3 months from today</p>
            </div>

            <!-- Location -->
            <div class="form-section">
                <h3 class="section-title"><i class="fas fa-map-marker-alt"></i> Location</h3>
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label asp-for="Venue" class="form-label">Venue Name *</label>
                        <input asp-for="Venue" class="form-control" placeholder="e.g., Town Hall, Community Center" id="venueInput" />
                        <span asp-validation-for="Venue" class="text-danger"></span>
                        <div class="validation-error" id="venueError">Venue name is required</div>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label asp-for="Address" class="form-label">Full Address *</label>
                        <input asp-for="Address" class="form-control" id="addressInput" placeholder="e.g., Town Hall, Kattappana, Kerala" />
                        <span asp-validation-for="Address" class="text-danger"></span>
                        <div class="validation-error" id="addressError">Address is required</div>
                        <div class="geocode-status" id="geocodeStatus"></div>
                    </div>
                </div>
                <button type="button" class="btn btn-outline-success btn-sm mb-2" id="geocodeBtn">
                    <i class="fas fa-search-location me-1"></i>Find on Map
                </button>
                <input type="hidden" asp-for="Latitude" id="latitude" />
                <input type="hidden" asp-for="Longitude" id="longitude" />
                <div id="map"></div>
                <p class="form-text mt-2"><i class="fas fa-info-circle me-1"></i>Click "Find on Map" or click directly on the map to set location</p>
            </div>

            <!-- Ticketing -->
            <div class="form-section">
                <h3 class="section-title"><i class="fas fa-ticket-alt"></i> Ticketing</h3>
                <div class="price-toggle">
                    <div class="price-option active" id="freeOption" onclick="setFreeEvent(true)">
                        <i class="fas fa-gift"></i>
                        <h4>Free Event</h4>
                        <p>No ticket price</p>
                    </div>
                    <div class="price-option" id="paidOption" onclick="setFreeEvent(false)">
                        <i class="fas fa-rupee-sign"></i>
                        <h4>Paid Event</h4>
                        <p>Set ticket price</p>
                    </div>
                </div>
                <input type="hidden" asp-for="IsFreeEvent" id="isFreeEvent" value="true" />
                
                <div id="priceSection">
                    <label asp-for="TicketPrice" class="form-label">Ticket Price (₹) * (Max: ₹10,000)</label>
                    <input asp-for="TicketPrice" type="number" class="form-control" min="1" max="10000" step="1" placeholder="Enter price" id="priceInput" />
                    <span asp-validation-for="TicketPrice" class="text-danger"></span>
                    <div class="validation-error" id="priceError">Ticket price must be between ₹1 and ₹10,000</div>
                </div>
            </div>

            <!-- Cover Image -->
            <div class="form-section">
                <h3 class="section-title"><i class="fas fa-image"></i> Cover Image</h3>
                
                <div class="image-upload-container">
                    <div class="image-upload-tab active" id="urlTab" onclick="switchImageTab('url')">
                        <i class="fas fa-link me-2"></i>Image URL
                    </div>
                    <div class="image-upload-tab" id="uploadTab" onclick="switchImageTab('upload')">
                        <i class="fas fa-upload me-2"></i>Upload Image
                    </div>
                </div>

                <div id="urlSection" class="mb-3">
                    <label asp-for="CoverImageUrl" class="form-label">Cover Image URL</label>
                    <input asp-for="CoverImageUrl" class="form-control" placeholder="https://example.com/image.jpg" id="imageUrlInput" />
                    <p class="form-text">Enter a URL for your event cover image (e.g., from Unsplash, Imgur)</p>
                </div>

                <div class="image-upload-area" id="uploadSection">
                    <i class="fas fa-cloud-upload-alt d-block"></i>
                    <p class="mb-2">Click to upload or drag and drop</p>
                    <p class="form-text">PNG, JPG up to 5MB</p>
                    <input type="file" id="imageFileInput" accept="image/*" style="display: none;" />
                </div>

                <div class="image-preview" id="imagePreview" style="display: none;">
                    <p class="form-text mb-2">Preview:</p>
                    <img id="previewImg" src="" alt="Preview" />
                    <button type="button" class="btn btn-sm btn-outline-danger ms-2" onclick="clearImagePreview()">
                        <i class="fas fa-times"></i> Remove
                    </button>
                </div>
            </div>

            <!-- Contact Info -->
            <div class="form-section">
                <h3 class="section-title"><i class="fas fa-address-book"></i> Contact Information</h3>
                <div class="row">
                    <div class="col-md-4 mb-3">
                        <label asp-for="ContactName" class="form-label">Contact Name *</label>
                        <input asp-for="ContactName" class="form-control" id="contactNameInput" />
                        <span asp-validation-for="ContactName" class="text-danger"></span>
                        <div class="validation-error" id="contactNameError">Contact name is required</div>
                    </div>
                    <div class="col-md-4 mb-3">
                        <label asp-for="ContactPhone" class="form-label">Contact Phone *</label>
                        <input asp-for="ContactPhone" class="form-control" id="contactPhoneInput" />
                        <span asp-validation-for="ContactPhone" class="text-danger"></span>
                        <div class="validation-error" id="contactPhoneError">Valid phone number is required</div>
                    </div>
                    <div class="col-md-4 mb-3">
                        <label asp-for="ContactEmail" class="form-label">Contact Email</label>
                        <input asp-for="ContactEmail" type="email" class="form-control" id="contactEmailInput" />
                        <span asp-validation-for="ContactEmail" class="text-danger"></span>
                        <div class="validation-error" id="contactEmailError">Please enter a valid email</div>
                    </div>
                </div>
            </div>

            <div class="text-end">
                <button type="submit" class="btn-submit" id="submitBtn">
                    <i class="fas fa-check me-2"></i>Create Event
                </button>
            </div>
        </form>
    </div>
</div>

@section Scripts {
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
    let map, marker;
    let formValid = false;
    const maxDate = new Date();
    maxDate.setMonth(maxDate.getMonth() + 3);

    document.addEventListener('DOMContentLoaded', function() {
        initMap();
        initValidation();
        initImageUpload();
        setMinDates();
        validateForm();
    });

    function initMap() {
        map = L.map('map').setView([10.8505, 76.2711], 10);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '© OpenStreetMap'
        }).addTo(map);

        marker = L.marker([10.8505, 76.2711], { draggable: true }).addTo(map);

        marker.on('dragend', function(e) {
            const pos = marker.getLatLng();
            document.getElementById('latitude').value = pos.lat;
            document.getElementById('longitude').value = pos.lng;
            reverseGeocode(pos.lat, pos.lng);
        });

        map.on('click', function(e) {
            marker.setLatLng(e.latlng);
            document.getElementById('latitude').value = e.latlng.lat;
            document.getElementById('longitude').value = e.latlng.lng;
            reverseGeocode(e.latlng.lat, e.latlng.lng);
        });

        document.getElementById('geocodeBtn').addEventListener('click', geocodeAddress);
    }

    async function geocodeAddress() {
        const venue = document.getElementById('venueInput').value;
        const address = document.getElementById('addressInput').value;
        const searchQuery = address || venue;
        
        if (searchQuery.length < 3) {
            showGeocodeStatus('Please enter venue or address first', 'error');
            return;
        }

        showGeocodeStatus('Searching location...', 'loading');

        try {
            const response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(searchQuery)}&countrycodes=in`);
            const data = await response.json();
            
            if (data.length > 0) {
                const lat = parseFloat(data[0].lat);
                const lon = parseFloat(data[0].lon);
                map.setView([lat, lon], 15);
                marker.setLatLng([lat, lon]);
                document.getElementById('latitude').value = lat;
                document.getElementById('longitude').value = lon;
                showGeocodeStatus(`Found: ${data[0].display_name.substring(0, 60)}...`, 'success');
            } else {
                showGeocodeStatus('Location not found. Try a more specific address or click on map.', 'error');
            }
        } catch (e) {
            console.error('Geocoding error:', e);
            showGeocodeStatus('Error searching location. Please click on map to set location.', 'error');
        }
    }

    async function reverseGeocode(lat, lng) {
        try {
            const response = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}`);
            const data = await response.json();
            if (data.display_name) {
                showGeocodeStatus(`Location set: ${data.display_name.substring(0, 50)}...`, 'success');
            }
        } catch (e) {
            console.error('Reverse geocoding error:', e);
        }
    }

    function showGeocodeStatus(message, type) {
        const status = document.getElementById('geocodeStatus');
        status.textContent = message;
        status.className = 'geocode-status ' + type;
    }

    function setMinDates() {
        const now = new Date();
        const minDateTime = now.toISOString().slice(0, 16);
        const maxDateTime = maxDate.toISOString().slice(0, 16);
        
        document.getElementById('startDateInput').min = minDateTime;
        document.getElementById('startDateInput').max = maxDateTime;
        document.getElementById('endDateInput').min = minDateTime;
        document.getElementById('endDateInput').max = maxDateTime;
    }

    function initValidation() {
        const fields = ['titleInput', 'descriptionInput', 'categoryInput', 'capacityInput', 
                       'startDateInput', 'endDateInput', 'venueInput', 'addressInput',
                       'priceInput', 'contactNameInput', 'contactPhoneInput', 'contactEmailInput', 'imageUrlInput'];
        
        fields.forEach(id => {
            const el = document.getElementById(id);
            if (el) {
                el.addEventListener('input', () => validateField(id));
                el.addEventListener('blur', () => validateField(id));
                el.addEventListener('change', () => validateField(id));
            }
        });

        document.getElementById('createEventForm').addEventListener('submit', function(e) {
            validateForm();
            if (!formValid) {
                e.preventDefault();
                showWarning('Please fix the validation errors before submitting.');
                document.querySelector('.is-invalid')?.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
        });
    }

    function validateField(fieldId) {
        const field = document.getElementById(fieldId);
        if (!field) return true;
        
        let isValid = true;
        let errorId = fieldId.replace('Input', 'Error');
        const errorEl = document.getElementById(errorId);

        switch(fieldId) {
            case 'titleInput':
                isValid = field.value.length >= 5 && field.value.length <= 200;
                break;
            case 'descriptionInput':
                isValid = field.value.length >= 20 && field.value.length <= 5000;
                break;
            case 'categoryInput':
                isValid = field.value !== '';
                break;
            case 'capacityInput':
                const capacity = parseInt(field.value);
                isValid = capacity >= 1 && capacity <= 1000;
                if (capacity > 1000) {
                    if (errorEl) errorEl.textContent = 'Capacity cannot exceed 1,000';
                }
                break;
            case 'startDateInput':
                const startDate = new Date(field.value);
                const now = new Date();
                isValid = startDate > now;
                if (startDate <= now && field.value) {
                    if (errorEl) errorEl.textContent = 'Start date cannot be in the past';
                }
                if (startDate > maxDate) {
                    isValid = false;
                    if (errorEl) errorEl.textContent = 'Start date cannot be more than 3 months from now';
                }
                validateField('endDateInput');
                break;
            case 'endDateInput':
                const endDate = new Date(field.value);
                const startVal = document.getElementById('startDateInput').value;
                const startDt = startVal ? new Date(startVal) : null;
                isValid = field.value && endDate > (startDt || new Date());
                if (startDt && endDate <= startDt) {
                    if (errorEl) errorEl.textContent = 'End date must be after start date';
                }
                if (endDate > maxDate) {
                    isValid = false;
                    if (errorEl) errorEl.textContent = 'Event cannot extend beyond 3 months from now';
                }
                break;
            case 'venueInput':
                isValid = field.value.length >= 2;
                break;
            case 'addressInput':
                isValid = field.value.length >= 5;
                break;
            case 'priceInput':
                if (!document.getElementById('isFreeEvent').value || document.getElementById('isFreeEvent').value === 'false') {
                    const price = parseFloat(field.value);
                    isValid = price >= 1 && price <= 10000;
                    if (price > 10000) {
                        if (errorEl) errorEl.textContent = 'Ticket price cannot exceed ₹10,000';
                    }
                } else {
                    isValid = true;
                }
                break;
            case 'contactNameInput':
                isValid = field.value.length >= 2;
                break;
            case 'contactPhoneInput':
                isValid = /^[+]?[\d\s-]{10,15}$/.test(field.value.replace(/\s/g, ''));
                break;
            case 'contactEmailInput':
                isValid = field.value === '' || /^[^\s@@]+@@[^\s@@]+\.[^\s@@]+$/.test(field.value);
                break;
            case 'imageUrlInput':
                isValid = true; // Optional field
                break;
        }

        field.classList.toggle('is-invalid', !isValid && field.value !== '');
        field.classList.toggle('is-valid', isValid && field.value !== '');
        if (errorEl) errorEl.classList.toggle('show', !isValid && field.value !== '');

        validateForm();
        return isValid;
    }

    function validateForm() {
        const title = document.getElementById('titleInput').value;
        const description = document.getElementById('descriptionInput').value;
        const category = document.getElementById('categoryInput').value;
        const capacity = parseInt(document.getElementById('capacityInput').value);
        const startDate = document.getElementById('startDateInput').value;
        const endDate = document.getElementById('endDateInput').value;
        const venue = document.getElementById('venueInput').value;
        const address = document.getElementById('addressInput').value;
        const contactName = document.getElementById('contactNameInput').value;
        const contactPhone = document.getElementById('contactPhoneInput').value;
        const isFree = document.getElementById('isFreeEvent').value === 'true';
        const price = parseFloat(document.getElementById('priceInput').value) || 0;

        const now = new Date();
        const start = new Date(startDate);
        const end = new Date(endDate);

        let errors = [];

        if (title.length < 5) errors.push('Title too short');
        if (description.length < 20) errors.push('Description too short');
        if (!category) errors.push('Category not selected');
        if (capacity < 1 || capacity > 1000) errors.push('Invalid capacity');
        if (!startDate || start <= now) errors.push('Invalid start date');
        if (!endDate || end <= start) errors.push('Invalid end date');
        if (start > maxDate || end > maxDate) errors.push('Event exceeds 3 month limit');
        if (venue.length < 2) errors.push('Venue required');
        if (address.length < 5) errors.push('Address required');
        if (contactName.length < 2) errors.push('Contact name required');
        if (!/^[+]?[\d\s-]{10,15}$/.test(contactPhone.replace(/\s/g, ''))) errors.push('Invalid phone');
        if (!isFree && (price < 1 || price > 10000)) errors.push('Invalid ticket price');

        formValid = errors.length === 0;
        
        const submitBtn = document.getElementById('submitBtn');
        submitBtn.disabled = !formValid;

        if (errors.length > 0 && (title || description || category)) {
            showWarning('Missing or invalid: ' + errors.slice(0, 3).join(', ') + (errors.length > 3 ? '...' : ''));
        } else {
            hideWarning();
        }

        return formValid;
    }

    function showWarning(message) {
        const warning = document.getElementById('formWarning');
        document.getElementById('warningMessage').textContent = message;
        warning.classList.add('show');
    }

    function hideWarning() {
        document.getElementById('formWarning').classList.remove('show');
    }

    function setFreeEvent(isFree) {
        document.getElementById('isFreeEvent').value = isFree;
        document.getElementById('freeOption').classList.toggle('active', isFree);
        document.getElementById('paidOption').classList.toggle('active', !isFree);
        document.getElementById('priceSection').classList.toggle('show', !isFree);
        
        if (isFree) {
            document.getElementById('priceInput').value = '0';
            document.getElementById('priceInput').classList.remove('is-invalid');
            document.getElementById('priceError').classList.remove('show');
        }
        validateForm();
    }

    function initImageUpload() {
        const uploadArea = document.getElementById('uploadSection');
        const fileInput = document.getElementById('imageFileInput');
        const urlInput = document.getElementById('imageUrlInput');

        uploadArea.addEventListener('click', () => fileInput.click());
        
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.style.borderColor = '#10B981';
            uploadArea.style.background = '#f0fdf4';
        });

        uploadArea.addEventListener('dragleave', () => {
            uploadArea.style.borderColor = '#d1d5db';
            uploadArea.style.background = '';
        });

        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.style.borderColor = '#d1d5db';
            uploadArea.style.background = '';
            if (e.dataTransfer.files.length) {
                handleImageFile(e.dataTransfer.files[0]);
            }
        });

        fileInput.addEventListener('change', (e) => {
            if (e.target.files.length) {
                handleImageFile(e.target.files[0]);
            }
        });

        urlInput.addEventListener('input', function() {
            if (this.value) {
                showImagePreview(this.value);
            } else {
                clearImagePreview();
            }
        });

        urlInput.addEventListener('blur', function() {
            if (this.value) {
                showImagePreview(this.value);
            }
        });
    }

    function handleImageFile(file) {
        if (!file.type.startsWith('image/')) {
            alert('Please select an image file');
            return;
        }
        if (file.size > 5 * 1024 * 1024) {
            alert('Image must be less than 5MB');
            return;
        }

        const reader = new FileReader();
        reader.onload = function(e) {
            showImagePreview(e.target.result);
            document.getElementById('imageUrlInput').value = e.target.result;
        };
        reader.readAsDataURL(file);
    }

    function switchImageTab(tab) {
        document.getElementById('urlTab').classList.toggle('active', tab === 'url');
        document.getElementById('uploadTab').classList.toggle('active', tab === 'upload');
        document.getElementById('urlSection').style.display = tab === 'url' ? 'block' : 'none';
        document.getElementById('uploadSection').classList.toggle('show', tab === 'upload');
    }

    function showImagePreview(src) {
        const preview = document.getElementById('imagePreview');
        const img = document.getElementById('previewImg');
        img.src = src;
        img.onerror = function() {
            preview.style.display = 'none';
        };
        img.onload = function() {
            preview.style.display = 'block';
        };
    }

    function clearImagePreview() {
        document.getElementById('imagePreview').style.display = 'none';
        document.getElementById('previewImg').src = '';
        document.getElementById('imageUrlInput').value = '';
        document.getElementById('imageFileInput').value = '';
    }
</script>
}
