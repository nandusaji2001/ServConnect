@model ServConnect.ViewModels.EventDetailsViewModel
@{
    ViewData["Title"] = Model.Event.Title;
    var evt = Model.Event;
    var existingTicketQty = Model.UserTicket?.Quantity ?? 0;
    var maxAdditionalTickets = Math.Min(10 - existingTicketQty, evt.RemainingSeats);
    var isEnded = evt.IsEnded || evt.Status == ServConnect.Models.EventStatus.Completed;
    var isCancelled = evt.Status == ServConnect.Models.EventStatus.Cancelled;
}

<style>
    .event-details { max-width: 1200px; margin: 0 auto; padding: 24px 16px; }
    
    @@media (min-width: 1200px) {
        .event-details { padding: 24px 32px; }
    }
    .event-hero { position: relative; height: 400px; border-radius: 20px; overflow: hidden; margin-bottom: 32px; background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%); }
    .event-hero img { width: 100%; height: 100%; object-fit: cover; }
    .event-hero-overlay { position: absolute; bottom: 0; left: 0; right: 0; background: linear-gradient(transparent, rgba(0,0,0,0.8)); padding: 40px 32px 32px; color: white; }
    .event-hero-overlay h1 { font-size: 2.5rem; font-weight: 700; margin-bottom: 12px; }
    .event-badges { display: flex; gap: 10px; margin-bottom: 16px; }
    .badge-item { padding: 6px 14px; border-radius: 20px; font-size: 0.85rem; font-weight: 600; display: flex; align-items: center; gap: 6px; }
    .badge-category { background: rgba(255,255,255,0.2); }
    .badge-free { background: #10B981; }
    .badge-paid { background: #3B82F6; }
    .badge-ended { background: #6b7280; }
    .badge-cancelled { background: #ef4444; }
    .event-content { display: grid; grid-template-columns: 1fr 380px; gap: 32px; }
    .content-card { background: white; border-radius: 16px; padding: 24px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); margin-bottom: 24px; }
    .content-card h3 { font-size: 1.2rem; font-weight: 600; color: #1f2937; margin-bottom: 16px; display: flex; align-items: center; gap: 10px; }
    .content-card h3 i { color: #10B981; }
    .event-description { color: #4b5563; line-height: 1.8; white-space: pre-wrap; }
    .info-list { display: flex; flex-direction: column; gap: 16px; }
    .info-item { display: flex; align-items: flex-start; gap: 16px; padding: 16px; background: #f9fafb; border-radius: 12px; }
    .info-icon { width: 44px; height: 44px; border-radius: 12px; background: linear-gradient(135deg, #10B981 0%, #059669 100%); display: flex; align-items: center; justify-content: center; color: white; font-size: 1.1rem; flex-shrink: 0; }
    .info-content h4 { font-size: 0.85rem; color: #6b7280; margin: 0 0 4px; }
    .info-content p { font-size: 1rem; color: #1f2937; margin: 0; font-weight: 500; }
    #detailMap { height: 300px; border-radius: 12px; }
    .ticket-card { background: white; border-radius: 16px; padding: 24px; box-shadow: 0 4px 20px rgba(0,0,0,0.1); position: sticky; top: 100px; margin-bottom: 24px; }
    .ticket-price { text-align: center; padding-bottom: 20px; border-bottom: 1px solid #e5e7eb; margin-bottom: 20px; }
    .ticket-price .price { font-size: 2.5rem; font-weight: 700; color: #10B981; }
    .ticket-price .label { color: #6b7280; font-size: 0.9rem; }
    .seats-info { display: flex; justify-content: space-between; align-items: center; padding: 12px 16px; background: #f0fdf4; border-radius: 10px; margin-bottom: 20px; }
    .seats-info.low { background: #fef2f2; }
    .seats-info.low .seats-count { color: #EF4444; }
    .seats-count { font-weight: 700; font-size: 1.1rem; color: #10B981; }
    .quantity-selector { display: flex; align-items: center; gap: 12px; margin-bottom: 20px; }
    .quantity-selector label { font-weight: 500; }
    .quantity-selector select { flex: 1; padding: 10px; border-radius: 8px; border: 1px solid #d1d5db; }
    .btn-book { width: 100%; padding: 16px; border-radius: 12px; background: linear-gradient(135deg, #10B981 0%, #059669 100%); color: white; font-weight: 600; font-size: 1.1rem; border: none; cursor: pointer; transition: all 0.3s; display: flex; align-items: center; justify-content: center; gap: 10px; }
    .btn-book:hover { transform: translateY(-2px); box-shadow: 0 10px 30px rgba(16,185,129,0.3); }
    .btn-book:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
    .btn-book.sold-out { background: #9ca3af; }
    .ticket-owned { text-align: center; padding: 16px; background: #f0fdf4; border-radius: 12px; margin-bottom: 16px; }
    .ticket-owned i { font-size: 1.5rem; color: #10B981; margin-bottom: 8px; }
    .ticket-owned h4 { color: #059669; margin-bottom: 6px; font-size: 1rem; }
    .ticket-code { font-family: monospace; font-size: 1rem; color: #1f2937; }
    .organizer-actions { display: flex; gap: 10px; margin-top: 20px; padding-top: 20px; border-top: 1px solid #e5e7eb; }
    .organizer-actions .btn { flex: 1; }
    .contact-card { background: white; border-radius: 16px; padding: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
    .contact-card h4 { font-size: 1rem; font-weight: 600; color: #1f2937; margin-bottom: 16px; display: flex; align-items: center; gap: 8px; }
    .contact-card h4 i { color: #10B981; }
    .contact-item { display: flex; align-items: center; gap: 12px; padding: 10px 0; border-bottom: 1px solid #f3f4f6; }
    .contact-item:last-child { border-bottom: none; }
    .contact-item i { width: 32px; height: 32px; background: #f0fdf4; border-radius: 8px; display: flex; align-items: center; justify-content: center; color: #10B981; font-size: 0.9rem; }
    .contact-item span { font-size: 0.9rem; color: #374151; }
    .contact-item a { color: #10B981; text-decoration: none; }
    .contact-item a:hover { text-decoration: underline; }
    @@media (max-width: 900px) { 
        .event-content { grid-template-columns: 1fr; } 
        .ticket-card { position: static; } 
        .event-hero { height: 280px; } 
        .event-hero-overlay h1 { font-size: 1.8rem; } 
        .event-details { padding: 16px 12px; }
    }
</style>

<div class="event-details">
    <a href="@Url.Action("Index", "Events")" class="btn btn-outline-secondary mb-3">
        <i class="fas fa-arrow-left me-2"></i>Back to Events
    </a>

    <div class="event-hero">
        @if (!string.IsNullOrEmpty(evt.CoverImageUrl))
        {
            <img src="@evt.CoverImageUrl" alt="@evt.Title" />
        }
        <div class="event-hero-overlay">
            <div class="event-badges">
                <span class="badge-item badge-category">@evt.Category</span>
                @if (isCancelled)
                {
                    <span class="badge-item badge-cancelled"><i class="fas fa-ban"></i> Cancelled</span>
                }
                else if (isEnded)
                {
                    <span class="badge-item badge-ended"><i class="fas fa-flag-checkered"></i> Event Ended</span>
                }
                else if (evt.IsFreeEvent)
                {
                    <span class="badge-item badge-free"><i class="fas fa-gift"></i> Free</span>
                }
                else
                {
                    <span class="badge-item badge-paid"><i class="fas fa-ticket-alt"></i> ₹@evt.TicketPrice</span>
                }
            </div>
            <h1>@evt.Title</h1>
            <p><i class="fas fa-user me-2"></i>Organized by @evt.OrganizerName</p>
        </div>
    </div>

    <div class="event-content">
        <div class="event-main">
            <!-- Event Info -->
            <div class="content-card">
                <h3><i class="fas fa-info-circle"></i> Event Details</h3>
                <div class="info-list">
                    <div class="info-item">
                        <div class="info-icon"><i class="fas fa-calendar"></i></div>
                        <div class="info-content">
                            <h4>Date</h4>
                            <p>@evt.StartDateTime.ToLocalTime().ToString("dddd, MMMM dd, yyyy")</p>
                        </div>
                    </div>
                    <div class="info-item">
                        <div class="info-icon"><i class="fas fa-clock"></i></div>
                        <div class="info-content">
                            <h4>Time</h4>
                            <p>@evt.StartDateTime.ToLocalTime().ToString("hh:mm tt") - @evt.EndDateTime.ToLocalTime().ToString("hh:mm tt")</p>
                        </div>
                    </div>
                    <div class="info-item">
                        <div class="info-icon"><i class="fas fa-map-marker-alt"></i></div>
                        <div class="info-content">
                            <h4>Location</h4>
                            <p>@evt.Venue</p>
                            <p class="text-muted small">@evt.Address</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Description -->
            <div class="content-card">
                <h3><i class="fas fa-align-left"></i> About This Event</h3>
                <div class="event-description">@evt.Description</div>
            </div>

            <!-- Map Section (moved from sidebar) -->
            @if (evt.Latitude != 0 && evt.Longitude != 0)
            {
                <div class="content-card">
                    <h3><i class="fas fa-map"></i> Event Location</h3>
                    <div id="detailMap"></div>
                    <p class="text-muted small mt-2"><i class="fas fa-map-marker-alt me-1"></i>@evt.Venue, @evt.Address</p>
                </div>
            }
        </div>

        <div class="event-sidebar">
            <!-- Ticket Card -->
            <div class="ticket-card">
                <div class="ticket-price">
                    @if (evt.IsFreeEvent)
                    {
                        <div class="price">Free</div>
                        <div class="label">No ticket required</div>
                    }
                    else
                    {
                        <div class="price">₹@evt.TicketPrice</div>
                        <div class="label">per ticket</div>
                    }
                </div>

                <div class="seats-info @(evt.RemainingSeats < 10 ? "low" : "")">
                    <span>Available Seats</span>
                    <span class="seats-count">@evt.RemainingSeats / @evt.Capacity</span>
                </div>

                @if (Model.IsOrganizer)
                {
                    <div class="ticket-owned" style="background: #f3f4f6;">
                        <i class="fas fa-user-tie" style="color: #6b7280;"></i>
                        <h4 style="color: #374151;">You are the organizer</h4>
                        <p class="small text-muted">You cannot book tickets for your own event</p>
                    </div>
                }
                else if (isEnded)
                {
                    @if (Model.HasPurchasedTicket && Model.UserTicket != null)
                    {
                        <div class="ticket-owned">
                            <i class="fas fa-check-circle"></i>
                            <h4>You attended this event!</h4>
                            <p class="ticket-code">@Model.UserTicket.TicketCode</p>
                            <p class="small text-muted mt-2">Qty: @Model.UserTicket.Quantity</p>
                        </div>
                    }
                    <button class="btn-book sold-out" disabled>
                        <i class="fas fa-flag-checkered"></i> Event Ended
                    </button>
                }
                else if (isCancelled)
                {
                    <button class="btn-book sold-out" disabled>
                        <i class="fas fa-ban"></i> Event Cancelled
                    </button>
                }
                else if (evt.IsSoldOut)
                {
                    @if (Model.HasPurchasedTicket && Model.UserTicket != null)
                    {
                        <div class="ticket-owned">
                            <i class="fas fa-check-circle"></i>
                            <h4>You have a ticket!</h4>
                            <p class="ticket-code">@Model.UserTicket.TicketCode</p>
                            <p class="small text-muted mt-2">Qty: @Model.UserTicket.Quantity</p>
                        </div>
                    }
                    <button class="btn-book sold-out" disabled>
                        <i class="fas fa-times-circle"></i> Sold Out
                    </button>
                }
                else if (Model.HasPurchasedTicket && Model.UserTicket != null)
                {
                    <!-- User has ticket but can buy more -->
                    <div class="ticket-owned">
                        <i class="fas fa-check-circle"></i>
                        <h4>You have a ticket!</h4>
                        <p class="ticket-code">@Model.UserTicket.TicketCode</p>
                        <p class="small text-muted mt-2">Current Qty: @Model.UserTicket.Quantity / 10</p>
                    </div>
                    
                    @if (existingTicketQty < 10 && maxAdditionalTickets > 0)
                    {
                        <div class="mt-3 pt-3 border-top">
                            <p class="small text-muted mb-2"><i class="fas fa-plus-circle me-1"></i>Need more tickets?</p>
                            <form asp-action="AddMoreTickets" method="post">
                                @Html.AntiForgeryToken()
                                <input type="hidden" name="EventId" value="@evt.Id" />
                                <input type="hidden" name="TicketId" value="@Model.UserTicket.Id" />
                                
                                <div class="quantity-selector">
                                    <label>Add:</label>
                                    <select name="AdditionalQuantity">
                                        @for (int i = 1; i <= maxAdditionalTickets; i++)
                                        {
                                            <option value="@i">+@i</option>
                                        }
                                    </select>
                                </div>
                                
                                <button type="submit" class="btn-book" style="background: linear-gradient(135deg, #3B82F6 0%, #2563EB 100%);">
                                    <i class="fas fa-plus"></i>
                                    @(evt.IsFreeEvent ? "Add More" : "Buy More Tickets")
                                </button>
                            </form>
                        </div>
                    }
                    else if (existingTicketQty >= 10)
                    {
                        <p class="small text-muted text-center mt-2"><i class="fas fa-info-circle me-1"></i>Maximum 10 tickets reached</p>
                    }
                }
                else
                {
                    <!-- New ticket purchase -->
                    <form asp-action="PurchaseTicket" method="post">
                        @Html.AntiForgeryToken()
                        <input type="hidden" name="EventId" value="@evt.Id" />
                        
                        <div class="quantity-selector">
                            <label>Quantity:</label>
                            <select name="Quantity">
                                @for (int i = 1; i <= Math.Min(10, evt.RemainingSeats); i++)
                                {
                                    <option value="@i">@i</option>
                                }
                            </select>
                        </div>
                        
                        <button type="submit" class="btn-book">
                            <i class="fas fa-ticket-alt"></i>
                            @(evt.IsFreeEvent ? "Register Now" : "Book Tickets")
                        </button>
                    </form>
                }

                @if (Model.IsOrganizer)
                {
                    <div class="organizer-actions">
                        @if (isCancelled)
                        {
                            <div class="alert alert-secondary w-100 mb-0 text-center">
                                <i class="fas fa-ban me-2"></i>This event has been cancelled
                            </div>
                        }
                        else if (isEnded)
                        {
                            <div class="alert alert-secondary w-100 mb-0 text-center">
                                <i class="fas fa-flag-checkered me-2"></i>This event has ended
                            </div>
                        }
                        else
                        {
                            <a href="@Url.Action("Edit", "Events", new { id = evt.Id })" class="btn btn-outline-primary">
                                <i class="fas fa-edit"></i> Edit
                            </a>
                            <form asp-action="Cancel" method="post" style="flex:1" 
                                  onsubmit="return confirm('Are you sure you want to cancel this event? All ticket holders will be notified and refunds will be processed.')">
                                @Html.AntiForgeryToken()
                                <input type="hidden" name="id" value="@evt.Id" />
                                <button type="submit" class="btn btn-outline-danger w-100">
                                    <i class="fas fa-times"></i> Cancel
                                </button>
                            </form>
                        }
                    </div>
                }
            </div>

            <!-- Contact Organizer Card (moved to sidebar) -->
            <div class="contact-card">
                <h4><i class="fas fa-address-book"></i> Contact Organizer</h4>
                <div class="contact-item">
                    <i class="fas fa-user"></i>
                    <span>@evt.ContactName</span>
                </div>
                @if (!string.IsNullOrEmpty(evt.ContactPhone))
                {
                    <div class="contact-item">
                        <i class="fas fa-phone"></i>
                        <span><a href="tel:@evt.ContactPhone">@evt.ContactPhone</a></span>
                    </div>
                }
                @if (!string.IsNullOrEmpty(evt.ContactEmail))
                {
                    <div class="contact-item">
                        <i class="fas fa-envelope"></i>
                        <span><a href="mailto:@evt.ContactEmail">@evt.ContactEmail</a></span>
                    </div>
                }
            </div>
        </div>
    </div>
</div>

@section Scripts {
@if (evt.Latitude != 0 && evt.Longitude != 0)
{
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const map = L.map('detailMap').setView([@evt.Latitude, @evt.Longitude], 15);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '© OpenStreetMap'
            }).addTo(map);
            L.marker([@evt.Latitude, @evt.Longitude])
                .addTo(map)
                .bindPopup('<b>@evt.Venue.Replace("'", "\\'")</b><br>@evt.Address.Replace("'", "\\'")')
                .openPopup();
        });
    </script>
}
}
