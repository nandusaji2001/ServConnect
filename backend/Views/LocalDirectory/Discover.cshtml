@{
    ViewData["Title"] = Localizer["Title.SearchLocalServices"];
}
<div class="container-fluid py-4">
    <h2 class="mb-3">@Localizer["Heading.SearchLocalServices"]</h2>
    <div class="card">
        <div class="card-header d-flex gap-2 align-items-center flex-wrap">
            <select id="loc" class="form-select w-auto">
                <option selected>Kattappana</option>
                <option>Nedumkandam</option>
                <option>Kanjirappally</option>
                <option>Kumily</option>
                <option>Kuttikkanam</option>
            </select>
            <select id="cat" class="form-select w-auto"></select>
            <input id="q" class="form-control" placeholder="@Localizer["SearchLocalPlaceholder"]">
            <button class="btn btn-primary" id="btnSearch" title="@Localizer["Search"]"><i class="fas fa-search"></i></button>
        </div>
        <div class="p-3">
            <style>
                /* Quick predefined cards */
                .osm-quick-cards { display:grid; grid-template-columns: repeat(4,1fr); gap:16px; }
                .osm-card { 
                    background: linear-gradient(135deg, #ffffff 0%, #f6faff 100%);
                    border:1px solid #e2e8f0; border-radius:16px; padding:0; cursor:pointer; 
                    transition:transform .2s ease, box-shadow .2s ease, border-color .2s ease; box-shadow:0 2px 6px rgba(0,0,0,.04);
                    overflow: hidden;
                    position: relative;
                }
                .osm-card-image-wrapper {
                    width: 100%;
                    height: 120px;
                    overflow: hidden;
                    position: relative;
                }
                .osm-card-image {
                    width: 100%;
                    height: 100%;
                    object-fit: cover;
                    transition: transform .3s ease;
                }
                .osm-card .service-name {
                    padding: 12px 16px;
                    font-weight: 600;
                    font-size: 1rem;
                    color: #0f172a;
                    text-align: center;
                }
                .osm-card:hover {
                    box-shadow:0 12px 24px rgba(37,99,235,.15); 
                    transform: translateY(-3px); 
                    border-color:#c7d2fe;
                }
                .osm-card:hover .osm-card-image {
                    transform: scale(1.05);
                }
                @@media (max-width: 992px){ .osm-quick-cards{ grid-template-columns: repeat(3,1fr);} }
                @@media (max-width: 576px){ .osm-quick-cards{ grid-template-columns: repeat(2,1fr);} }
                /* Category tiles */
                .category-card.tile{ border-radius:12px; border:1px solid #e5e7eb; transition: box-shadow .2s ease, transform .2s ease; }
                .category-card.tile:hover{ box-shadow:0 10px 20px rgba(0,0,0,.08); transform: translateY(-2px); }
                .category-card .card-title{ font-size:1.125rem; }
                
                /* Loading skeleton */
                .image-placeholder {
                    background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
                    background-size: 200% 100%;
                    animation: loading 1.5s infinite;
                }
                @@keyframes loading {
                    0% { background-position: 200% 0; }
                    100% { background-position: -200% 0; }
                }
            </style>
            <div class="osm-quick-cards" id="quickCards">
                <div class="osm-card" data-name="Hospital">
                    <div class="osm-card-image-wrapper image-placeholder"></div>
                    <div class="service-name">@Localizer["Quick.Hospital"]</div>
                </div>
                <div class="osm-card" data-name="Pharmacy">
                    <div class="osm-card-image-wrapper image-placeholder"></div>
                    <div class="service-name">@Localizer["Quick.Pharmacy"]</div>
                </div>
                <div class="osm-card" data-name="Clinic">
                    <div class="osm-card-image-wrapper image-placeholder"></div>
                    <div class="service-name">@Localizer["Quick.Clinic"]</div>
                </div>
                <div class="osm-card" data-name="Police Station">
                    <div class="osm-card-image-wrapper image-placeholder"></div>
                    <div class="service-name">@Localizer["Quick.Police"]</div>
                </div>
                <div class="osm-card" data-name="Fuel / Gas Station">
                    <div class="osm-card-image-wrapper image-placeholder"></div>
                    <div class="service-name">@Localizer["Quick.Fuel"]</div>
                </div>
                <div class="osm-card" data-name="Restaurant">
                    <div class="osm-card-image-wrapper image-placeholder"></div>
                    <div class="service-name">@Localizer["Quick.Restaurant"]</div>
                </div>
                <div class="osm-card" data-name="Cafe">
                    <div class="osm-card-image-wrapper image-placeholder"></div>
                    <div class="service-name">@Localizer["Quick.Cafe"]</div>
                </div>
                <div class="osm-card" data-name="Fast Food">
                    <div class="osm-card-image-wrapper image-placeholder"></div>
                    <div class="service-name">@Localizer["Quick.FastFood"]</div>
                </div>
                <div class="osm-card" data-name="Bank / ATM">
                    <div class="osm-card-image-wrapper image-placeholder"></div>
                    <div class="service-name">@Localizer["Quick.BankATM"]</div>
                </div>
                <div class="osm-card" data-name="Post Office">
                    <div class="osm-card-image-wrapper image-placeholder"></div>
                    <div class="service-name">@Localizer["Quick.PostOffice"]</div>
                </div>
                <div class="osm-card" data-name="School">
                    <div class="osm-card-image-wrapper image-placeholder"></div>
                    <div class="service-name">@Localizer["Quick.School"]</div>
                </div>
                <div class="osm-card" data-name="University">
                    <div class="osm-card-image-wrapper image-placeholder"></div>
                    <div class="service-name">@Localizer["Quick.University"]</div>
                </div>
                <div class="osm-card" data-name="Bus Stop">
                    <div class="osm-card-image-wrapper image-placeholder"></div>
                    <div class="service-name">@Localizer["Quick.BusStop"]</div>
                </div>
                <div class="osm-card" data-name="Train Station">
                    <div class="osm-card-image-wrapper image-placeholder"></div>
                    <div class="service-name">@Localizer["Quick.Train"]</div>
                </div>
                <div class="osm-card" data-name="Airport">
                    <div class="osm-card-image-wrapper image-placeholder"></div>
                    <div class="service-name">@Localizer["Quick.Airport"]</div>
                </div>
                <div class="osm-card" data-name="Taxi Stand">
                    <div class="osm-card-image-wrapper image-placeholder"></div>
                    <div class="service-name">@Localizer["Quick.Taxi"]</div>
                </div>
                <div class="osm-card" data-name="Park / Garden">
                    <div class="osm-card-image-wrapper image-placeholder"></div>
                    <div class="service-name">@Localizer["Quick.Park"]</div>
                </div>
                <div class="osm-card" data-name="Playground">
                    <div class="osm-card-image-wrapper image-placeholder"></div>
                    <div class="service-name">@Localizer["Quick.Playground"]</div>
                </div>
                <div class="osm-card" data-name="Cinema / Movie Theater">
                    <div class="osm-card-image-wrapper image-placeholder"></div>
                    <div class="service-name">@Localizer["Quick.Cinema"]</div>
                </div>
                <div class="osm-card" data-name="Museum">
                    <div class="osm-card-image-wrapper image-placeholder"></div>
                    <div class="service-name">@Localizer["Quick.Museum"]</div>
                </div>
                <div class="osm-card" data-name="Art Gallery">
                    <div class="osm-card-image-wrapper image-placeholder"></div>
                    <div class="service-name">@Localizer["Quick.ArtGallery"]</div>
                </div>
                <div class="osm-card" data-name="Hotel">
                    <div class="osm-card-image-wrapper image-placeholder"></div>
                    <div class="service-name">@Localizer["Quick.Hotel"]</div>
                </div>
                <div class="osm-card" data-name="Guest House">
                    <div class="osm-card-image-wrapper image-placeholder"></div>
                    <div class="service-name">@Localizer["Quick.GuestHouse"]</div>
                </div>
                <div class="osm-card" data-name="Parking Lot / Garage">
                    <div class="osm-card-image-wrapper image-placeholder"></div>
                    <div class="service-name">@Localizer["Quick.Parking"]</div>
                </div>
                <div class="osm-card" data-name="Ferry Terminal">
                    <div class="osm-card-image-wrapper image-placeholder"></div>
                    <div class="service-name">@Localizer["Quick.Ferry"]</div>
                </div>
                
                <div class="osm-card" data-name="Grocery Store">
                    <div class="osm-card-image-wrapper image-placeholder"></div>
                    <div class="service-name">@Localizer["Quick.GroceryStore"]</div>
                </div>
                <div class="osm-card" data-name="Supermarket">
                    <div class="osm-card-image-wrapper image-placeholder"></div>
                    <div class="service-name">@Localizer["Quick.Supermarket"]</div>
                </div>
                <div class="osm-card" data-name="Medical Store">
                    <div class="osm-card-image-wrapper image-placeholder"></div>
                    <div class="service-name">@Localizer["Quick.MedicalStore"]</div>
                </div>
                <div class="osm-card" data-name="Dentist">
                    <div class="osm-card-image-wrapper image-placeholder"></div>
                    <div class="service-name">@Localizer["Quick.Dentist"]</div>
                </div>
                
                <div class="osm-card" data-name="Lawyer">
                    <div class="osm-card-image-wrapper image-placeholder"></div>
                    <div class="service-name">@Localizer["Quick.Lawyer"]</div>
                </div>
                <div class="osm-card" data-name="Accountant">
                    <div class="osm-card-image-wrapper image-placeholder"></div>
                    <div class="service-name">@Localizer["Quick.Accountant"]</div>
                </div>
                <div class="osm-card" data-name="Car Repair">
                    <div class="osm-card-image-wrapper image-placeholder"></div>
                    <div class="service-name">@Localizer["Quick.CarRepair"]</div>
                </div>
                <div class="osm-card" data-name="Plumber">
                    <div class="osm-card-image-wrapper image-placeholder"></div>
                    <div class="service-name">@Localizer["Quick.Plumber"]</div>
                </div>
                <div class="osm-card" data-name="Electrician">
                    <div class="osm-card-image-wrapper image-placeholder"></div>
                    <div class="service-name">@Localizer["Quick.Electrician"]</div>
                </div>
                
                <div class="osm-card" data-name="Barber Shop">
                    <div class="osm-card-image-wrapper image-placeholder"></div>
                    <div class="service-name">@Localizer["Quick.BarberShop"]</div>
                </div>
                <div class="osm-card" data-name="Beauty Salon">
                    <div class="osm-card-image-wrapper image-placeholder"></div>
                    <div class="service-name">@Localizer["Quick.BeautySalon"]</div>
                </div>
                <div class="osm-card" data-name="Gym">
                    <div class="osm-card-image-wrapper image-placeholder"></div>
                    <div class="service-name">@Localizer["Quick.Gym"]</div>
                </div>
                
                <div class="osm-card" data-name="Clothing Store">
                    <div class="osm-card-image-wrapper image-placeholder"></div>
                    <div class="service-name">@Localizer["Quick.ClothingStore"]</div>
                </div>
                <div class="osm-card" data-name="Electronics Store">
                    <div class="osm-card-image-wrapper image-placeholder"></div>
                    <div class="service-name">@Localizer["Quick.ElectronicsStore"]</div>
                </div>
                <div class="osm-card" data-name="Mobile Shop">
                    <div class="osm-card-image-wrapper image-placeholder"></div>
                    <div class="service-name">@Localizer["Quick.MobileShop"]</div>
                </div>
                <div class="osm-card" data-name="Bakery">
                    <div class="osm-card-image-wrapper image-placeholder"></div>
                    <div class="service-name">@Localizer["Quick.Bakery"]</div>
                </div>
                
                <div class="osm-card" data-name="Auto Stand">
                    <div class="osm-card-image-wrapper image-placeholder"></div>
                    <div class="service-name">@Localizer["Quick.AutoStand"]</div>
                </div>
                <div class="osm-card" data-name="Car Rental">
                    <div class="osm-card-image-wrapper image-placeholder"></div>
                    <div class="service-name">@Localizer["Quick.CarRental"]</div>
                </div>
                
                <div class="osm-card" data-name="Temple">
                    <div class="osm-card-image-wrapper image-placeholder"></div>
                    <div class="service-name">@Localizer["Quick.Temple"]</div>
                </div>
                <div class="osm-card" data-name="Church">
                    <div class="osm-card-image-wrapper image-placeholder"></div>
                    <div class="service-name">@Localizer["Quick.Church"]</div>
                </div>
                <div class="osm-card" data-name="Mosque">
                    <div class="osm-card-image-wrapper image-placeholder"></div>
                    <div class="service-name">@Localizer["Quick.Mosque"]</div>
                </div>
            </div>
        </div>
        <div id="tileGrid" class="p-3">
            <div class="text-muted">@Localizer["LoadingCategories"]</div>
        </div>
    </div>
</div>
<script>
    function navigateToBrowse(params){
        const url = new URL(location.origin + '/local/services/browse');
        if(params.q) url.searchParams.set('q', params.q);
        if(params.categorySlug) url.searchParams.set('categorySlug', params.categorySlug);
        if(params.locationName) url.searchParams.set('locationName', params.locationName);
        location.href = url.toString();
    }

    function renderTiles(cats){
        const grid = document.getElementById('tileGrid');
        grid.innerHTML = '';
        const row = document.createElement('div');
        row.className = 'row g-4';
        cats.forEach(c => {
            const col = document.createElement('div');
            col.className = 'col-12 col-md-6 col-lg-3';
            col.innerHTML = `<div class="card h-100 tile category-card" data-slug="${c.slug}">
                <div class="card-body d-flex flex-column">
                    <div class="d-flex align-items-center mb-2">
                        <i class="bi bi-geo-alt-fill me-2 text-primary"></i>
                        <h5 class="card-title mb-0">${c.name}</h5>
                    </div>
                    <p class="card-text text-muted small">@Localizer["ClickToViewServices"]</p>
                    <div class="mt-auto text-end">
                        <button class="btn btn-outline-primary btn-sm">@Localizer["View"]</button>
                    </div>
                </div>
            </div>`;
            row.appendChild(col);
        });
        grid.appendChild(row);
        grid.querySelectorAll('.tile').forEach(tile => {
            tile.addEventListener('click', ()=>{
                const slug = tile.getAttribute('data-slug');
                const loc = document.getElementById('loc').value;
                navigateToBrowse({ q: '', categorySlug: slug, locationName: loc });
            });
        });
    }

    async function loadCats(){
        const sel = document.getElementById('cat');
        sel.innerHTML = '<option value="">All Categories</option>';
        try{
            const res = await fetch('/api/local/categories');
            const cats = await res.json();
            // Populate dropdown with all categories (unchanged)
            cats.forEach(c => {
                const o = document.createElement('option');
                o.value = c.slug;
                o.textContent = c.name;
                sel.appendChild(o);
            });
            // Exclude bottom duplicate tiles for Hospital, Police, Fuel/Petrol
            const filtered = cats.filter(c => {
                const n = (c.name || '').toLowerCase();
                return !(n.includes('hospital') || n.includes('police') || n.includes('fuel') || n.includes('petrol'));
            });
            renderTiles(filtered);
        }catch{ document.getElementById('tileGrid').innerHTML = '<div class="text-danger">Failed to load categories.</div>'; }
    }

    async function fetchPexelsImage(serviceName) {
        try {
            const response = await fetch(`/api/pexels/image?serviceName=${encodeURIComponent(serviceName)}`);
            if (response.ok) {
                const data = await response.json();
                return data.imageUrl;
            }
        } catch (e) {
            console.error('Error fetching Pexels image:', e);
        }
        return null;
    }

    // Optimized function to load all Pexels images concurrently
    async function loadPexelsImages() {
        const cards = document.querySelectorAll('#quickCards .osm-card');
        
        // Create an array of promises for all image fetches
        const imagePromises = Array.from(cards).map(card => {
            const name = card.getAttribute('data-name');
            return fetchPexelsImage(name).then(imageUrl => ({ card, imageUrl }));
        });
        
        // Wait for all promises to resolve
        const results = await Promise.all(imagePromises);
        
        // Update all cards with their images
        results.forEach(({ card, imageUrl }) => {
            if (imageUrl) {
                const wrapper = card.querySelector('.osm-card-image-wrapper');
                if (wrapper) {
                    wrapper.classList.remove('image-placeholder');
                    wrapper.innerHTML = `<img src="${imageUrl}" alt="${card.querySelector('.service-name').textContent}" class="osm-card-image">`;
                }
            }
        });
    }

    document.addEventListener('DOMContentLoaded', async ()=>{
        await loadCats();
        await loadPexelsImages();
        document.getElementById('btnSearch').addEventListener('click', () => {
            const q = document.getElementById('q').value.trim();
            const cat = document.getElementById('cat').value;
            const loc = document.getElementById('loc').value;
            navigateToBrowse({ q, categorySlug: cat, locationName: loc });
        });
        document.querySelectorAll('#quickCards .osm-card').forEach(el => {
            el.addEventListener('click', () => {
                const name = el.getAttribute('data-name');
                const loc = document.getElementById('loc').value;
                navigateToBrowse({ q: name, categorySlug: '', locationName: loc });
            });
        });
    });
</script>