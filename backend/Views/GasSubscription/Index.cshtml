@model ServConnect.Models.GasSubscriptionDashboard
@{
    ViewData["Title"] = "Gas Cylinder Monitor";
    var vendors = ViewBag.Vendors as List<ServConnect.Models.Users> ?? new List<ServConnect.Models.Users>();
}

<div class="container-fluid py-4">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center flex-wrap gap-3">
                <div>
                    <h2 class="mb-1">
                        <i class="bi bi-fire text-warning me-2"></i>
                        Gas Cylinder Monitor
                    </h2>
                    <p class="text-muted mb-0">IoT-based automatic gas monitoring and booking</p>
                </div>
                <div class="d-flex gap-2">
                    <a href="@Url.Action("Settings", "GasSubscription")" class="btn btn-outline-primary">
                        <i class="bi bi-gear me-1"></i> Settings
                    </a>
                    <a href="@Url.Action("PlaceOrder", "GasSubscription")" class="btn btn-success">
                        <i class="bi bi-cart-plus me-1"></i> Order Gas
                    </a>
                </div>
            </div>
        </div>
    </div>

    @if (Model?.Subscription == null)
    {
        <!-- No Subscription Setup Yet -->
        <div class="row">
            <div class="col-12">
                <div class="card border-0 shadow-sm">
                    <div class="card-body text-center py-5">
                        <i class="bi bi-fire display-1 text-warning mb-4"></i>
                        <h4>Set Up Gas Cylinder Monitoring</h4>
                        <p class="text-muted mb-4">
                            Connect your IoT device to automatically monitor gas levels and 
                            get automatic refills when your cylinder runs low.
                        </p>
                        <a href="@Url.Action("Settings", "GasSubscription")" class="btn btn-primary btn-lg">
                            <i class="bi bi-gear me-2"></i>Configure Now
                        </a>
                    </div>
                </div>
            </div>
        </div>
    }
    else
    {
        <!-- Main Dashboard -->
        <div class="row g-4">
            <!-- Gas Cylinder Visual Card -->
            <div class="col-lg-4 col-md-6">
                <div class="card border-0 shadow-sm h-100">
                    <div class="card-body text-center">
                        <h5 class="card-title mb-3">
                            <i class="bi bi-fire me-2"></i>Gas Cylinder Status
                        </h5>
                        
                        <!-- Gas Cylinder Visual -->
                        <div class="gas-cylinder-container mb-3">
                            <div class="gas-cylinder">
                                <div class="cylinder-cap"></div>
                                <div class="cylinder-valve"></div>
                                <div class="cylinder-body">
                                    <div class="gas-level" id="gasLevelFill" style="height: @Model.CurrentGasPercentage%;">
                                        <div class="gas-bubbles">
                                            <span class="bubble"></span>
                                            <span class="bubble"></span>
                                            <span class="bubble"></span>
                                        </div>
                                    </div>
                                    <div class="cylinder-lines">
                                        <div class="line" style="bottom: 75%;"><span>75%</span></div>
                                        <div class="line" style="bottom: 50%;"><span>50%</span></div>
                                        <div class="line" style="bottom: 25%;"><span>25%</span></div>
                                    </div>
                                </div>
                                <div class="cylinder-base"></div>
                            </div>
                            <div class="cylinder-shadow"></div>
                        </div>
                        
                        <div class="mb-2">
                            <span class="display-4 fw-bold" id="gasPercentage">@Model.CurrentGasPercentage.ToString("F0")</span>
                            <span class="fs-4">%</span>
                        </div>
                        
                        <div class="mb-2">
                            <span id="gasStatus" class="badge fs-6 @GetStatusBadgeClass(Model.GasStatus)">
                                @Model.GasStatus
                            </span>
                        </div>
                        
                        <p class="text-muted small mb-0">
                            <i class="bi bi-clock me-1"></i>
                            <span id="lastUpdate">@(Model.Subscription.LastReadingAt?.ToString("g") ?? "Never")</span>
                            <span class="ms-2 badge bg-light text-dark" id="refreshIndicator">
                                <i class="bi bi-arrow-repeat"></i> Live
                            </span>
                        </p>
                    </div>
                </div>
            </div>

            <!-- Weight & Status Card -->
            <div class="col-lg-4 col-md-6">
                <div class="card border-0 shadow-sm h-100">
                    <div class="card-body">
                        <h5 class="card-title mb-4">
                            <i class="bi bi-box me-2"></i>Cylinder Details
                        </h5>
                        
                        <div class="mb-3">
                            <div class="d-flex justify-content-between mb-1">
                                <span class="text-muted">Current Weight</span>
                                <span id="currentWeight" class="fw-bold">@((Model.CurrentWeightGrams / 1000).ToString("F2")) kg</span>
                            </div>
                            <div class="progress" style="height: 8px;">
                                <div class="progress-bar @GetProgressBarClass(Model.GasStatus)" 
                                     role="progressbar" 
                                     style="width: @Model.CurrentGasPercentage%"
                                     id="weightProgress"></div>
                            </div>
                        </div>
                        
                        <hr />
                        
                        <div class="row g-2">
                            <div class="col-6">
                                <div class="p-2 bg-light rounded text-center">
                                    <small class="text-muted d-block">Full Weight</small>
                                    <span class="fw-bold">@((Model.Subscription.FullCylinderWeightGrams / 1000).ToString("F1")) kg</span>
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="p-2 bg-light rounded text-center">
                                    <small class="text-muted d-block">Threshold</small>
                                    <span class="fw-bold">@Model.Subscription.ThresholdPercentage%</span>
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="p-2 bg-light rounded text-center">
                                    <small class="text-muted d-block">Auto-Booking</small>
                                    <span class="fw-bold @(Model.Subscription.IsAutoBookingEnabled ? "text-success" : "text-danger")">
                                        @(Model.Subscription.IsAutoBookingEnabled ? "Enabled" : "Disabled")
                                    </span>
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="p-2 bg-light rounded text-center">
                                    <small class="text-muted d-block">Device</small>
                                    <span class="fw-bold text-truncate d-block" style="max-width: 100px;">
                                        @(Model.Subscription.DeviceId ?? "Not Set")
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Current Order / Vendor Card -->
            <div class="col-lg-4 col-md-12">
                <div class="card border-0 shadow-sm h-100">
                    <div class="card-body">
                        @if (Model.CurrentOrder != null)
                        {
                            <h5 class="card-title mb-3">
                                <i class="bi bi-truck me-2"></i>Active Order
                            </h5>
                            
                            <div class="alert @GetOrderAlertClass(Model.CurrentOrder.Status) mb-3">
                                <div class="d-flex align-items-center">
                                    <i class="bi @GetOrderIcon(Model.CurrentOrder.Status) me-2 fs-4"></i>
                                    <div>
                                        <strong>@Model.CurrentOrder.Status</strong>
                                        @if (Model.CurrentOrder.IsAutoTriggered)
                                        {
                                            <span class="badge bg-info ms-2">Auto</span>
                                        }
                                        <br />
                                        <small>@Model.CurrentOrder.VendorName</small>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Order Progress -->
                            <div class="position-relative mb-3">
                                <div class="progress" style="height: 4px;">
                                    <div class="progress-bar bg-success" style="width: @GetOrderProgress(Model.CurrentOrder.Status)%"></div>
                                </div>
                                <div class="d-flex justify-content-between mt-1">
                                    <small class="@(Model.CurrentOrder.Status >= GasOrderStatus.Pending ? "text-success" : "text-muted")">
                                        <i class="bi bi-circle-fill" style="font-size: 8px;"></i> Ordered
                                    </small>
                                    <small class="@(Model.CurrentOrder.Status >= GasOrderStatus.Accepted ? "text-success" : "text-muted")">
                                        <i class="bi bi-circle-fill" style="font-size: 8px;"></i> Accepted
                                    </small>
                                    <small class="@(Model.CurrentOrder.Status >= GasOrderStatus.OutForDelivery ? "text-success" : "text-muted")">
                                        <i class="bi bi-circle-fill" style="font-size: 8px;"></i> Shipping
                                    </small>
                                    <small class="@(Model.CurrentOrder.Status >= GasOrderStatus.Delivered ? "text-success" : "text-muted")">
                                        <i class="bi bi-circle-fill" style="font-size: 8px;"></i> Delivered
                                    </small>
                                </div>
                            </div>
                            
                            <div class="small text-muted">
                                <p class="mb-1"><strong>Order ID:</strong> @Model.CurrentOrder.Id?.Substring(0, 8)...</p>
                                <p class="mb-1"><strong>Price:</strong> â‚¹@Model.CurrentOrder.Price</p>
                                <p class="mb-0"><strong>Ordered:</strong> @Model.CurrentOrder.CreatedAt.ToString("g")</p>
                            </div>
                        }
                        else
                        {
                            <h5 class="card-title mb-3">
                                <i class="bi bi-shop me-2"></i>Preferred Vendor
                            </h5>
                            
                            @if (Model.Subscription.PreferredVendorId != null)
                            {
                                <div class="text-center py-3">
                                    <i class="bi bi-building display-6 text-primary mb-2"></i>
                                    <h6 class="mb-1">@Model.Subscription.PreferredVendorName</h6>
                                    <p class="text-muted small mb-3">Your preferred gas supplier</p>
                                    <a href="@Url.Action("PlaceOrder", "GasSubscription")" class="btn btn-sm btn-primary">
                                        <i class="bi bi-cart-plus me-1"></i>Order Now
                                    </a>
                                </div>
                            }
                            else
                            {
                                <div class="text-center py-3">
                                    <i class="bi bi-exclamation-triangle display-6 text-warning mb-2"></i>
                                    <p class="text-muted mb-3">No vendor selected for auto-booking</p>
                                    <a href="@Url.Action("Settings", "GasSubscription")" class="btn btn-sm btn-outline-primary">
                                        <i class="bi bi-gear me-1"></i>Configure
                                    </a>
                                </div>
                            }
                        }
                    </div>
                </div>
            </div>
        </div>

        <!-- Recent Orders Row -->
        <div class="row g-4 mt-2">
            <div class="col-12">
                <div class="card border-0 shadow-sm">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h5 class="card-title mb-0">
                                <i class="bi bi-clock-history me-2"></i>Recent Orders
                            </h5>
                            <a href="@Url.Action("Orders", "GasSubscription")" class="btn btn-sm btn-link">View All</a>
                        </div>
                        
                        @if (Model.OrderHistory?.Any() == true)
                        {
                            <div class="list-group list-group-flush">
                                @foreach (var order in Model.OrderHistory.Take(5))
                                {
                                    <div class="list-group-item px-0 d-flex justify-content-between align-items-center">
                                        <div>
                                            <span class="fw-medium">@order.VendorName</span>
                                            @if (order.IsAutoTriggered)
                                            {
                                                <span class="badge bg-info ms-1">Auto</span>
                                            }
                                            <br />
                                            <small class="text-muted">@order.CreatedAt.ToString("MMM dd, yyyy")</small>
                                        </div>
                                        <span class="badge @GetStatusBadgeClass(order.Status.ToString())">
                                            @order.Status
                                        </span>
                                    </div>
                                }
                            </div>
                        }
                        else
                        {
                            <p class="text-muted text-center py-4">No orders yet</p>
                        }
                    </div>
                </div>
            </div>
        </div>
    }
</div>

@section Scripts {
    <script>
        // Auto-refresh dashboard every 3 seconds
        let refreshInterval = null;
        
        function startRefresh() {
            if (refreshInterval) clearInterval(refreshInterval);
            refreshInterval = setInterval(refreshDashboard, 3000);
            // Initial refresh
            refreshDashboard();
        }
        
        async function refreshDashboard() {
            try {
                const indicator = document.getElementById('refreshIndicator');
                if (indicator) indicator.innerHTML = '<i class="bi bi-arrow-repeat spin"></i> Updating...';
                
                const response = await fetch('/api/GasSubscriptionApi/readings/latest');
                if (response.ok) {
                    const data = await response.json();
                    if (data && data.gasPercentage !== undefined) {
                        // Update percentage display
                        document.getElementById('gasPercentage').textContent = Math.round(data.gasPercentage);
                        document.getElementById('gasStatus').textContent = data.status;
                        document.getElementById('currentWeight').textContent = (data.weightGrams / 1000).toFixed(2) + ' kg';
                        document.getElementById('weightProgress').style.width = data.gasPercentage + '%';
                        document.getElementById('lastUpdate').textContent = new Date(data.timestamp).toLocaleString();
                        
                        // Update gas cylinder fill level
                        const gasLevelFill = document.getElementById('gasLevelFill');
                        if (gasLevelFill) {
                            gasLevelFill.style.height = data.gasPercentage + '%';
                            // Update color based on status
                            gasLevelFill.className = 'gas-level gas-level-' + data.status.toLowerCase();
                        }
                        
                        // Update status badge color
                        const statusBadge = document.getElementById('gasStatus');
                        statusBadge.className = 'badge fs-6 ' + getStatusClass(data.status);
                        
                        // Update progress bar class
                        const progressBar = document.getElementById('weightProgress');
                        progressBar.className = 'progress-bar ' + getProgressClass(data.status);
                    }
                }
                
                if (indicator) indicator.innerHTML = '<i class="bi bi-arrow-repeat"></i> Live';
            } catch (e) {
                console.log('Dashboard refresh failed:', e);
                const indicator = document.getElementById('refreshIndicator');
                if (indicator) indicator.innerHTML = '<i class="bi bi-exclamation-circle"></i> Offline';
            }
        }
        
        function getStatusClass(status) {
            switch(status) {
                case 'Full': return 'bg-success';
                case 'Good': return 'bg-info';
                case 'Half': return 'bg-warning text-dark';
                case 'Low': return 'bg-warning text-dark';
                case 'Critical': return 'bg-danger';
                default: return 'bg-secondary';
            }
        }
        
        function getProgressClass(status) {
            switch(status) {
                case 'Full': case 'Good': return 'bg-success';
                case 'Half': return 'bg-warning';
                case 'Low': return 'bg-warning';
                case 'Critical': return 'bg-danger';
                default: return 'bg-secondary';
            }
        }
        
        // Start refresh when page is visible, pause when hidden
        document.addEventListener('visibilitychange', () => {
            if (document.hidden) {
                if (refreshInterval) clearInterval(refreshInterval);
            } else {
                startRefresh();
            }
        });
        
        startRefresh();
    </script>
    
    <style>
        /* Gas Cylinder Styles */
        .gas-cylinder-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
        }
        
        .gas-cylinder {
            position: relative;
            width: 120px;
        }
        
        .cylinder-cap {
            width: 40px;
            height: 15px;
            background: linear-gradient(to bottom, #666, #444);
            margin: 0 auto;
            border-radius: 5px 5px 0 0;
            position: relative;
        }
        
        .cylinder-valve {
            width: 20px;
            height: 25px;
            background: linear-gradient(to right, #555, #777, #555);
            margin: 0 auto;
            border-radius: 3px;
        }
        
        .cylinder-body {
            width: 100%;
            height: 180px;
            background: linear-gradient(to right, #e74c3c 0%, #c0392b 20%, #e74c3c 50%, #c0392b 80%, #e74c3c 100%);
            border-radius: 10px 10px 20px 20px;
            position: relative;
            overflow: hidden;
            box-shadow: inset -10px 0 20px rgba(0,0,0,0.3), inset 10px 0 20px rgba(255,255,255,0.1);
        }
        
        .gas-level {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: linear-gradient(to top, #3498db, #5dade2, #85c1e9);
            transition: height 0.5s ease-out;
            border-radius: 0 0 18px 18px;
        }
        
        .gas-level-full, .gas-level-good {
            background: linear-gradient(to top, #27ae60, #2ecc71, #58d68d);
        }
        
        .gas-level-half {
            background: linear-gradient(to top, #f39c12, #f1c40f, #f9e79f);
        }
        
        .gas-level-low {
            background: linear-gradient(to top, #e67e22, #f39c12, #f8c471);
        }
        
        .gas-level-critical {
            background: linear-gradient(to top, #c0392b, #e74c3c, #f1948a);
            animation: pulse-critical 1s ease-in-out infinite;
        }
        
        @@keyframes pulse-critical {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        
        .gas-bubbles {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 100%;
            overflow: hidden;
        }
        
        .bubble {
            position: absolute;
            bottom: -20px;
            width: 10px;
            height: 10px;
            background: rgba(255,255,255,0.4);
            border-radius: 50%;
            animation: bubble-rise 3s ease-in infinite;
        }
        
        .bubble:nth-child(1) { left: 20%; animation-delay: 0s; }
        .bubble:nth-child(2) { left: 50%; animation-delay: 1s; width: 8px; height: 8px; }
        .bubble:nth-child(3) { left: 75%; animation-delay: 2s; width: 6px; height: 6px; }
        
        @@keyframes bubble-rise {
            0% { transform: translateY(0) scale(1); opacity: 0.6; }
            100% { transform: translateY(-180px) scale(0.5); opacity: 0; }
        }
        
        .cylinder-lines {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            pointer-events: none;
        }
        
        .cylinder-lines .line {
            position: absolute;
            left: 0;
            right: 0;
            height: 1px;
            background: rgba(255,255,255,0.3);
        }
        
        .cylinder-lines .line span {
            position: absolute;
            right: -35px;
            top: -8px;
            font-size: 10px;
            color: #999;
        }
        
        .cylinder-base {
            width: 110px;
            height: 15px;
            background: linear-gradient(to bottom, #444, #222);
            margin: 0 auto;
            border-radius: 0 0 10px 10px;
        }
        
        .cylinder-shadow {
            width: 100px;
            height: 20px;
            background: radial-gradient(ellipse, rgba(0,0,0,0.3) 0%, transparent 70%);
            margin: 5px auto 0;
        }
        
        /* Spin animation for refresh indicator */
        .spin {
            animation: spin 1s linear infinite;
        }
        
        @@keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
    </style>
}

@functions {
    string GetStatusColor(string status)
    {
        return status switch
        {
            "Full" => "#198754",
            "Good" => "#20c997",
            "Half" => "#ffc107",
            "Low" => "#fd7e14",
            "Critical" => "#dc3545",
            _ => "#6c757d"
        };
    }

    string GetStatusBadgeClass(string status)
    {
        return status switch
        {
            "Full" or "Delivered" => "bg-success",
            "Good" or "Accepted" => "bg-info",
            "Half" or "OutForDelivery" => "bg-warning text-dark",
            "Low" or "Pending" => "bg-warning text-dark",
            "Critical" or "Cancelled" or "Rejected" => "bg-danger",
            _ => "bg-secondary"
        };
    }

    string GetProgressBarClass(string status)
    {
        return status switch
        {
            "Full" or "Good" => "bg-success",
            "Half" => "bg-warning",
            "Low" => "bg-warning",
            "Critical" => "bg-danger",
            _ => "bg-secondary"
        };
    }

    string GetOrderAlertClass(GasOrderStatus status)
    {
        return status switch
        {
            GasOrderStatus.Pending => "alert-warning",
            GasOrderStatus.Accepted => "alert-info",
            GasOrderStatus.OutForDelivery => "alert-primary",
            GasOrderStatus.Delivered => "alert-success",
            _ => "alert-secondary"
        };
    }

    string GetOrderIcon(GasOrderStatus status)
    {
        return status switch
        {
            GasOrderStatus.Pending => "bi-hourglass-split",
            GasOrderStatus.Accepted => "bi-check-circle",
            GasOrderStatus.OutForDelivery => "bi-truck",
            GasOrderStatus.Delivered => "bi-check2-all",
            _ => "bi-circle"
        };
    }

    int GetOrderProgress(GasOrderStatus status)
    {
        return status switch
        {
            GasOrderStatus.Pending => 25,
            GasOrderStatus.Accepted => 50,
            GasOrderStatus.OutForDelivery => 75,
            GasOrderStatus.Delivered => 100,
            _ => 0
        };
    }
}
