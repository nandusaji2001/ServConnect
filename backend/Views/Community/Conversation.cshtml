@{
    ViewData["Title"] = "Conversation";
    Layout = null;
    var currentUser = ViewBag.CurrentUser as ServConnect.Models.Users;
    var otherUser = ViewBag.OtherUser as ServConnect.Models.Users;
}
<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat with @otherUser?.FullName - Community</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <link rel="stylesheet" href="/css/community.css">
    <script src="/js/community-translations.js"></script>
</head>
<body>
    <!-- Navigation Sidebar (Hidden on mobile) -->
    <nav class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <a href="/community" class="logo">
                <i class="fas fa-users"></i>
                <span>Community</span>
            </a>
        </div>
        
        <div class="sidebar-content">
            <ul class="nav-menu">
                <li class="nav-item">
                    <a href="/community" class="nav-link">
                        <i class="fas fa-home"></i>
                        <span>Feed</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="/community/search" class="nav-link">
                        <i class="fas fa-search"></i>
                        <span>Discover</span>
                    </a>
                </li>
                <li class="nav-item active">
                    <a href="/community/messages" class="nav-link">
                        <i class="fas fa-envelope"></i>
                        <span>Messages</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="/community/notifications" class="nav-link">
                        <i class="fas fa-bell"></i>
                        <span>Notifications</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="/community/profile" class="nav-link">
                        <i class="fas fa-user"></i>
                        <span>Profile</span>
                    </a>
                </li>
            </ul>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="main-content chat-page">
        <div class="chat-container">
            <!-- Chat Header -->
            <div class="chat-header">
                <a href="/community/messages" class="back-btn">
                    <i class="fas fa-arrow-left"></i>
                </a>
                <a href="/community/profile/@otherUser?.Id" class="chat-user-info">
                    <img src="@(otherUser?.ProfileImageUrl ?? "/images/default-avatar.png")" alt="@otherUser?.FullName" class="avatar-md">
                    <div>
                        <span class="chat-user-name">@otherUser?.FullName</span>
                        <span class="chat-user-status" id="userStatus">Last active recently</span>
                    </div>
                </a>
                <div class="chat-header-actions">
                    <button class="icon-btn" onclick="toggleChatMenu()">
                        <i class="fas fa-ellipsis-v"></i>
                    </button>
                    <div class="dropdown-menu" id="chatMenu">
                        <button onclick="viewProfile()">
                            <i class="fas fa-user"></i> View Profile
                        </button>
                        <button onclick="muteConversation()">
                            <i class="fas fa-bell-slash"></i> <span id="muteText">Mute</span>
                        </button>
                        <button onclick="blockUser()" class="danger">
                            <i class="fas fa-ban"></i> Block User
                        </button>
                        <button onclick="reportUser()" class="danger">
                            <i class="fas fa-flag"></i> Report
                        </button>
                    </div>
                </div>
            </div>

            <!-- Messages Container -->
            <div class="messages-content" id="messagesContent">
                <div class="loading-spinner" id="messagesLoading">
                    <i class="fas fa-spinner fa-spin"></i>
                    <span>Loading messages...</span>
                </div>
            </div>

            <!-- Message Input -->
            <div class="message-input-container">
                <form id="messageForm" class="message-form">
                    <div class="message-input-wrapper">
                        <button type="button" class="icon-btn" onclick="toggleVoiceRecording()" id="voiceBtn">
                            <i class="fas fa-microphone"></i>
                        </button>
                        <input type="text" id="messageInput" placeholder="Type a message..." autocomplete="off">
                        <button type="button" class="icon-btn" onclick="document.getElementById('imageInput').click()">
                            <i class="fas fa-image"></i>
                        </button>
                        <input type="file" id="imageInput" accept="image/*" style="display: none;" onchange="handleImageSelect(event)">
                    </div>
                    <button type="submit" class="send-btn" id="sendBtn">
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </form>
                
                <!-- Voice Recording UI -->
                <div class="voice-recording-ui" id="voiceRecordingUI" style="display: none;">
                    <div class="recording-indicator">
                        <span class="recording-dot"></span>
                        <span id="recordingTime">0:00</span>
                    </div>
                    <div class="recording-waveform" id="waveform"></div>
                    <div class="recording-actions">
                        <button type="button" class="btn btn-outline" onclick="cancelRecording()">
                            <i class="fas fa-times"></i> Cancel
                        </button>
                        <button type="button" class="btn btn-primary" onclick="sendVoiceMessage()">
                            <i class="fas fa-paper-plane"></i> Send
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Image Preview Modal -->
    <div class="modal" id="imagePreviewModal">
        <div class="modal-overlay" onclick="closeImagePreview()"></div>
        <div class="modal-content">
            <div class="modal-header">
                <h2>Send Image</h2>
                <button class="modal-close" onclick="closeImagePreview()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <img id="imagePreview" src="" alt="Preview" style="max-width: 100%; max-height: 400px;">
                <input type="text" id="imageCaption" placeholder="Add a caption..." class="image-caption-input">
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="closeImagePreview()">Cancel</button>
                <button class="btn btn-primary" onclick="sendImageMessage()">Send</button>
            </div>
        </div>
    </div>

    <!-- Report Modal -->
    <div class="modal" id="reportModal">
        <div class="modal-overlay" onclick="closeReportModal()"></div>
        <div class="modal-content">
            <div class="modal-header">
                <h2>Report User</h2>
                <button class="modal-close" onclick="closeReportModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <form id="reportForm" onsubmit="submitReport(event)">
                <div class="modal-body">
                    <div class="report-options">
                        <label class="report-option">
                            <input type="radio" name="reason" value="1" required>
                            <span>Harassment</span>
                        </label>
                        <label class="report-option">
                            <input type="radio" name="reason" value="0">
                            <span>Spam</span>
                        </label>
                        <label class="report-option">
                            <input type="radio" name="reason" value="6">
                            <span>Scam</span>
                        </label>
                        <label class="report-option">
                            <input type="radio" name="reason" value="7">
                            <span>Other</span>
                        </label>
                    </div>
                    <textarea name="additionalDetails" placeholder="Additional details..." rows="3"></textarea>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline" onclick="closeReportModal()">Cancel</button>
                    <button type="submit" class="btn btn-danger">Report</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Toast Notifications -->
    <div id="toastContainer" class="toast-container"></div>

    <script>
        const currentUserId = '@currentUser?.Id';
        const otherUserId = '@otherUser?.Id';
        const otherUserName = '@(otherUser?.FullName?.Replace("'", "\\'"))';
        const currentUserImage = '@(currentUser?.ProfileImageUrl ?? "/images/default-avatar.png")';
        const otherUserImage = '@(otherUser?.ProfileImageUrl ?? "/images/default-avatar.png")';

        let messages = [];
        let isRecording = false;
        let mediaRecorder;
        let audioChunks = [];
        let recordingStartTime;
        let recordingInterval;
        let selectedImage = null;
        let isMuted = false;

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            loadMessages();
            setupEventListeners();
            
            // Poll for new messages
            setInterval(checkNewMessages, 5000);
        });

        function setupEventListeners() {
            document.getElementById('messageForm').addEventListener('submit', handleSendMessage);
            
            document.getElementById('messageInput').addEventListener('keypress', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    handleSendMessage(e);
                }
            });
        }

        // Load messages
        async function loadMessages() {
            try {
                const response = await fetch(`/api/community/messages/${otherUserId}`);
                messages = await response.json();
                
                document.getElementById('messagesLoading').style.display = 'none';
                
                renderMessages();
                scrollToBottom();
                
                // Mark as read
                await fetch(`/api/community/messages/${otherUserId}/read`, { method: 'POST' });
            } catch (error) {
                console.error('Error loading messages:', error);
                showToast('Failed to load messages', 'error');
            }
        }

        function renderMessages() {
            const container = document.getElementById('messagesContent');
            
            if (messages.length === 0) {
                container.innerHTML = `
                    <div class="chat-empty-state">
                        <img src="${otherUserImage}" alt="${otherUserName}" class="avatar-lg">
                        <h3>Start chatting with ${escapeHtml(otherUserName)}</h3>
                        <p>Send a message to begin the conversation</p>
                    </div>
                `;
                return;
            }

            // Group messages by date
            const groupedMessages = groupMessagesByDate(messages);
            
            let html = '';
            for (const [date, msgs] of Object.entries(groupedMessages)) {
                html += `<div class="message-date-divider"><span>${date}</span></div>`;
                
                msgs.forEach((msg, i) => {
                    const isOwn = msg.senderId === currentUserId;
                    const showAvatar = !isOwn && (i === 0 || msgs[i-1]?.senderId !== msg.senderId);
                    
                    html += renderMessage(msg, isOwn, showAvatar);
                });
            }
            
            container.innerHTML = html;
        }

        function renderMessage(msg, isOwn, showAvatar) {
            const time = new Date(msg.createdAt).toLocaleTimeString('en-US', { 
                hour: 'numeric', 
                minute: '2-digit',
                hour12: true 
            });
            
            let content = '';
            
            if (msg.type === 1) { // Voice message
                content = `
                    <div class="voice-message">
                        <button class="play-btn" onclick="playVoiceMessage('${msg.audioUrl}', this)">
                            <i class="fas fa-play"></i>
                        </button>
                        <div class="voice-waveform">
                            <div class="waveform-bars"></div>
                        </div>
                        <span class="voice-duration">${formatDuration(msg.audioDurationSeconds || 0)}</span>
                    </div>
                    ${msg.transcribedText && msg.transcribedText !== '[Voice message]' ? `
                        <p class="voice-transcript">${escapeHtml(msg.transcribedText)}</p>
                    ` : ''}
                `;
            } else if (msg.type === 2) { // Image message
                content = `
                    <img src="${msg.content}" alt="Image" class="message-image" onclick="openImageViewer('${msg.content}')">
                `;
            } else { // Text message
                content = `<p class="message-text">${formatMessageContent(msg.content)}</p>`;
            }
            
            return `
                <div class="message ${isOwn ? 'own' : 'other'}" data-message-id="${msg.id}">
                    ${!isOwn && showAvatar ? `
                        <img src="${otherUserImage}" alt="${otherUserName}" class="message-avatar">
                    ` : !isOwn ? '<div class="message-avatar-spacer"></div>' : ''}
                    <div class="message-bubble">
                        ${content}
                        <div class="message-meta">
                            <span class="message-time">${time}</span>
                            ${isOwn ? `
                                <span class="message-status">
                                    ${msg.isRead ? '<i class="fas fa-check-double"></i>' : '<i class="fas fa-check"></i>'}
                                </span>
                            ` : ''}
                        </div>
                    </div>
                    ${isOwn ? `
                        <button class="message-menu-btn" onclick="showMessageMenu('${msg.id}')">
                            <i class="fas fa-ellipsis-v"></i>
                        </button>
                    ` : ''}
                </div>
            `;
        }

        function groupMessagesByDate(messages) {
            const groups = {};
            const today = new Date().toDateString();
            const yesterday = new Date(Date.now() - 86400000).toDateString();
            
            // Messages are returned in descending order, reverse for display
            [...messages].reverse().forEach(msg => {
                const date = new Date(msg.createdAt);
                const dateStr = date.toDateString();
                
                let label;
                if (dateStr === today) {
                    label = 'Today';
                } else if (dateStr === yesterday) {
                    label = 'Yesterday';
                } else {
                    label = date.toLocaleDateString('en-US', { 
                        weekday: 'long',
                        month: 'short', 
                        day: 'numeric' 
                    });
                }
                
                if (!groups[label]) groups[label] = [];
                groups[label].push(msg);
            });
            
            return groups;
        }

        function formatMessageContent(content) {
            if (!content) return '';
            
            let formatted = escapeHtml(content);
            
            // Convert URLs to links
            const urlRegex = /(https?:\/\/[^\s]+)/g;
            formatted = formatted.replace(urlRegex, '<a href="$1" target="_blank" rel="noopener">$1</a>');
            
            return formatted;
        }

        // Send message
        async function handleSendMessage(e) {
            e.preventDefault();
            const input = document.getElementById('messageInput');
            const content = input.value.trim();
            
            if (!content) return;
            
            input.value = '';
            
            // Optimistic update
            const tempMessage = {
                id: 'temp-' + Date.now(),
                senderId: currentUserId,
                content: content,
                type: 0,
                createdAt: new Date().toISOString(),
                isRead: false
            };
            
            messages.unshift(tempMessage);
            renderMessages();
            scrollToBottom();
            
            try {
                const formData = new FormData();
                formData.append('content', content);
                formData.append('type', '0');
                
                const response = await fetch(`/api/community/messages/${otherUserId}`, {
                    method: 'POST',
                    body: formData
                });
                
                if (!response.ok) {
                    throw new Error('Failed to send message');
                }
                
                const sentMessage = await response.json();
                
                // Replace temp message with real one
                const index = messages.findIndex(m => m.id === tempMessage.id);
                if (index >= 0) {
                    messages[index] = sentMessage;
                    renderMessages();
                }
            } catch (error) {
                // Remove temp message on error
                messages = messages.filter(m => m.id !== tempMessage.id);
                renderMessages();
                showToast('Failed to send message', 'error');
            }
        }

        // Voice message recording
        async function toggleVoiceRecording() {
            if (isRecording) {
                stopRecording();
            } else {
                await startRecording();
            }
        }

        async function startRecording() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                
                mediaRecorder = new MediaRecorder(stream);
                audioChunks = [];
                
                mediaRecorder.ondataavailable = (e) => {
                    audioChunks.push(e.data);
                };
                
                mediaRecorder.onstop = () => {
                    stream.getTracks().forEach(track => track.stop());
                };
                
                mediaRecorder.start();
                isRecording = true;
                recordingStartTime = Date.now();
                
                document.getElementById('messageForm').style.display = 'none';
                document.getElementById('voiceRecordingUI').style.display = 'flex';
                document.getElementById('voiceBtn').innerHTML = '<i class="fas fa-stop"></i>';
                
                // Update recording time
                recordingInterval = setInterval(() => {
                    const elapsed = Math.floor((Date.now() - recordingStartTime) / 1000);
                    const mins = Math.floor(elapsed / 60);
                    const secs = elapsed % 60;
                    document.getElementById('recordingTime').textContent = `${mins}:${secs.toString().padStart(2, '0')}`;
                }, 1000);
                
            } catch (error) {
                console.error('Error starting recording:', error);
                showToast('Could not access microphone', 'error');
            }
        }

        function stopRecording() {
            if (mediaRecorder && mediaRecorder.state !== 'inactive') {
                mediaRecorder.stop();
            }
            
            isRecording = false;
            clearInterval(recordingInterval);
            document.getElementById('voiceBtn').innerHTML = '<i class="fas fa-microphone"></i>';
        }

        function cancelRecording() {
            stopRecording();
            audioChunks = [];
            document.getElementById('voiceRecordingUI').style.display = 'none';
            document.getElementById('messageForm').style.display = 'flex';
        }

        async function sendVoiceMessage() {
            stopRecording();
            
            const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
            const duration = Math.floor((Date.now() - recordingStartTime) / 1000);
            
            document.getElementById('voiceRecordingUI').style.display = 'none';
            document.getElementById('messageForm').style.display = 'flex';
            
            // Show sending indicator
            const tempMessage = {
                id: 'temp-voice-' + Date.now(),
                senderId: currentUserId,
                type: 1,
                audioDurationSeconds: duration,
                createdAt: new Date().toISOString(),
                isRead: false
            };
            
            messages.unshift(tempMessage);
            renderMessages();
            scrollToBottom();
            
            try {
                const formData = new FormData();
                formData.append('content', '');
                formData.append('type', '1');
                formData.append('audio', audioBlob, 'voice.webm');
                
                const response = await fetch(`/api/community/messages/${otherUserId}`, {
                    method: 'POST',
                    body: formData
                });
                
                if (!response.ok) {
                    throw new Error('Failed to send voice message');
                }
                
                const sentMessage = await response.json();
                
                const index = messages.findIndex(m => m.id === tempMessage.id);
                if (index >= 0) {
                    messages[index] = sentMessage;
                    renderMessages();
                }
                
                showToast('Voice message sent!', 'success');
            } catch (error) {
                messages = messages.filter(m => m.id !== tempMessage.id);
                renderMessages();
                showToast('Failed to send voice message', 'error');
            }
            
            audioChunks = [];
        }

        // Play voice message
        function playVoiceMessage(url, button) {
            const audio = new Audio(url);
            const icon = button.querySelector('i');
            
            audio.onplay = () => {
                icon.className = 'fas fa-pause';
            };
            
            audio.onended = () => {
                icon.className = 'fas fa-play';
            };
            
            if (audio.paused) {
                audio.play();
            } else {
                audio.pause();
            }
        }

        // Image message
        function handleImageSelect(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            selectedImage = file;
            
            const reader = new FileReader();
            reader.onload = (e) => {
                document.getElementById('imagePreview').src = e.target.result;
                document.getElementById('imagePreviewModal').classList.add('show');
            };
            reader.readAsDataURL(file);
        }

        function closeImagePreview() {
            document.getElementById('imagePreviewModal').classList.remove('show');
            document.getElementById('imageInput').value = '';
            selectedImage = null;
        }

        async function sendImageMessage() {
            if (!selectedImage) return;
            
            const caption = document.getElementById('imageCaption').value.trim();
            closeImagePreview();
            
            const formData = new FormData();
            formData.append('content', caption);
            formData.append('type', '2');
            formData.append('audio', selectedImage);
            
            try {
                const response = await fetch(`/api/community/messages/${otherUserId}`, {
                    method: 'POST',
                    body: formData
                });
                
                if (response.ok) {
                    await loadMessages();
                    scrollToBottom();
                    showToast('Image sent!', 'success');
                }
            } catch (error) {
                showToast('Failed to send image', 'error');
            }
        }

        // Check for new messages
        async function checkNewMessages() {
            try {
                const response = await fetch(`/api/community/messages/${otherUserId}?limit=5`);
                const newMessages = await response.json();
                
                if (newMessages.length > 0 && newMessages[0].id !== messages[0]?.id) {
                    // New messages available
                    const existingIds = new Set(messages.map(m => m.id));
                    const actuallyNew = newMessages.filter(m => !existingIds.has(m.id));
                    
                    if (actuallyNew.length > 0) {
                        messages = [...actuallyNew, ...messages];
                        renderMessages();
                        scrollToBottom();
                        
                        // Mark as read
                        await fetch(`/api/community/messages/${otherUserId}/read`, { method: 'POST' });
                    }
                }
            } catch (error) {
                console.error('Error checking new messages:', error);
            }
        }

        // Message actions
        function showMessageMenu(messageId) {
            // Simple delete confirmation
            if (confirm('Delete this message?')) {
                deleteMessage(messageId);
            }
        }

        async function deleteMessage(messageId) {
            try {
                const response = await fetch(`/api/community/messages/${messageId}`, { method: 'DELETE' });
                
                if (response.ok) {
                    messages = messages.filter(m => m.id !== messageId);
                    renderMessages();
                    showToast('Message deleted', 'success');
                }
            } catch (error) {
                showToast('Failed to delete message', 'error');
            }
        }

        // Chat menu actions
        function toggleChatMenu() {
            document.getElementById('chatMenu').classList.toggle('show');
        }

        function viewProfile() {
            window.location.href = `/community/profile/${otherUserId}`;
        }

        async function muteConversation() {
            try {
                const response = await fetch(`/api/community/conversations/${otherUserId}/mute`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ mute: !isMuted })
                });
                
                if (response.ok) {
                    isMuted = !isMuted;
                    document.getElementById('muteText').textContent = isMuted ? 'Unmute' : 'Mute';
                    showToast(isMuted ? 'Conversation muted' : 'Conversation unmuted', 'success');
                }
            } catch (error) {
                showToast('Failed to update mute setting', 'error');
            }
            
            toggleChatMenu();
        }

        async function blockUser() {
            if (!confirm(`Block ${otherUserName}? You won't be able to send or receive messages from them.`)) return;
            
            try {
                await fetch(`/api/community/users/${otherUserId}/block`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({})
                });
                
                showToast('User blocked', 'success');
                window.location.href = '/community/messages';
            } catch (error) {
                showToast('Failed to block user', 'error');
            }
        }

        function reportUser() {
            document.getElementById('reportModal').classList.add('show');
            toggleChatMenu();
        }

        function closeReportModal() {
            document.getElementById('reportModal').classList.remove('show');
        }

        async function submitReport(e) {
            e.preventDefault();
            const form = e.target;
            const formData = new FormData(form);
            
            try {
                await fetch('/api/community/report', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        targetType: 2,
                        targetUserId: otherUserId,
                        reason: parseInt(formData.get('reason')),
                        additionalDetails: formData.get('additionalDetails')
                    })
                });
                
                closeReportModal();
                showToast('Report submitted', 'success');
            } catch (error) {
                showToast('Failed to submit report', 'error');
            }
        }

        // Utility functions
        function scrollToBottom() {
            const container = document.getElementById('messagesContent');
            container.scrollTop = container.scrollHeight;
        }

        function formatDuration(seconds) {
            const mins = Math.floor(seconds / 60);
            const secs = seconds % 60;
            return `${mins}:${secs.toString().padStart(2, '0')}`;
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text || '';
            return div.innerHTML;
        }

        function showToast(message, type = 'info') {
            const container = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            toast.className = `toast toast-${type}`;
            toast.innerHTML = `
                <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'info-circle'}"></i>
                <span>${message}</span>
            `;
            container.appendChild(toast);
            
            setTimeout(() => toast.classList.add('show'), 10);
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        function openImageViewer(url) {
            window.open(url, '_blank');
        }

        // Close menus on outside click
        document.addEventListener('click', (e) => {
            if (!e.target.closest('.chat-header-actions')) {
                document.getElementById('chatMenu').classList.remove('show');
            }
        });
    </script>
</body>
</html>
